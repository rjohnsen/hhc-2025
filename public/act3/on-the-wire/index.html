<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+926ba4d1230e27319cf62da0633eb3420e6af1bf">
    <meta name="description" content="Objective Difficulty Description 4/5 Help Evan next to city hall hack this gnome and retrieve the temperature value reported by the IÂ²C device at address 0x3C. The temperature data is XOR-encrypted, so youâ€™ll need to work through each communication stage to uncover the necessary keys. Start with the unencrypted data being transmitted over the 1-wire protocol. Evan Booth mission statement Hey, Iâ€™m Evan!">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="On the Wire :: SANS Holiday Hack Challenge 2025">
    <meta name="twitter:description" content="Objective Difficulty Description 4/5 Help Evan next to city hall hack this gnome and retrieve the temperature value reported by the IÂ²C device at address 0x3C. The temperature data is XOR-encrypted, so youâ€™ll need to work through each communication stage to uncover the necessary keys. Start with the unencrypted data being transmitted over the 1-wire protocol. Evan Booth mission statement Hey, Iâ€™m Evan!">
    <meta property="og:url" content="http://localhost:1313/act3/on-the-wire/index.html">
    <meta property="og:site_name" content="SANS Holiday Hack Challenge 2025">
    <meta property="og:title" content="On the Wire :: SANS Holiday Hack Challenge 2025">
    <meta property="og:description" content="Objective Difficulty Description 4/5 Help Evan next to city hall hack this gnome and retrieve the temperature value reported by the IÂ²C device at address 0x3C. The temperature data is XOR-encrypted, so youâ€™ll need to work through each communication stage to uncover the necessary keys. Start with the unencrypted data being transmitted over the 1-wire protocol. Evan Booth mission statement Hey, Iâ€™m Evan!">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="On the Wire :: SANS Holiday Hack Challenge 2025">
    <meta itemprop="description" content="Objective Difficulty Description 4/5 Help Evan next to city hall hack this gnome and retrieve the temperature value reported by the IÂ²C device at address 0x3C. The temperature data is XOR-encrypted, so youâ€™ll need to work through each communication stage to uncover the necessary keys. Start with the unencrypted data being transmitted over the 1-wire protocol. Evan Booth mission statement Hey, Iâ€™m Evan!">
    <meta itemprop="datePublished" content="2025-12-23T15:59:59+01:00">
    <meta itemprop="dateModified" content="2025-12-23T15:59:59+01:00">
    <meta itemprop="wordCount" content="4606">
    <title>On the Wire :: SANS Holiday Hack Challenge 2025</title>
    <link href="/act3/on-the-wire/index.xml" rel="alternate" type="application/rss+xml" title="On the Wire :: SANS Holiday Hack Challenge 2025">
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1767539554" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1767539554" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1767539554" rel="stylesheet">
    <link href="/css/theme.css?1767539554" rel="stylesheet">
    <link href="/css/format-html.css?1767539554" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/act3\/on-the-wire\/index.html';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'hhc-2025' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
  </head>
  <body class="mobile-support html" data-url="/act3/on-the-wire/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#objective">Objective</a></li>
    <li><a href="#evan-booth-mission-statement">Evan Booth mission statement</a></li>
    <li><a href="#solution">Solution</a>
      <ul>
        <li><a href="#1-wire">1-Wire</a></li>
        <li><a href="#spi">SPI</a></li>
        <li><a href="#i2c">I2C</a></li>
      </ul>
    </li>
    <li><a href="#evan-booth-closing-words">Evan Booth closing words</a></li>
    <li><a href="#hints">Hints</a>
      <ul>
        <li><a href="#on-rails">On Rails</a></li>
        <li><a href="#protocols">Protocols</a></li>
        <li><a href="#bits-and-bytes">Bits and Bytes</a></li>
        <li><a href="#garbage">Garbage?</a></li>
        <li><a href="#structure">Structure</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">Sans Holiday Hack Challenge 2025 - Introduction</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/act3/index.html"><span itemprop="name">Act 3</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">On the Wire</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/act3/find-and-shutdown-frostys-snowglobe-machine/index.html" title="Find and Shutdown Frostys Snowglobe Machine (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/act3/free-ski/index.html" title="Free Ski (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable act3" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="on-the-wire">On the Wire</h1>

<p><a href="#R-image-e658d75b810d91a91c12523ad4b42a67" class="lightbox-link"><img alt="Evan Booth" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/evanbooth-avatar.gif" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e658d75b810d91a91c12523ad4b42a67"><img alt="Evan Booth" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/evanbooth-avatar.gif"></a></p>
<h2 id="objective">Objective</h2>
<table>
  <thead>
      <tr>
          <th>Difficulty</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>4/5</td>
          <td>Help Evan next to city hall hack this gnome and retrieve the temperature value reported by the IÂ²C device at address 0x3C. The temperature data is XOR-encrypted, so youâ€™ll need to work through each communication stage to uncover the necessary keys. Start with the unencrypted data being transmitted over the 1-wire protocol.</td>
      </tr>
  </tbody>
</table>
<h2 id="evan-booth-mission-statement">Evan Booth mission statement</h2>
<blockquote>
<p>Hey, I&rsquo;m Evan!</p>
<p>I like to build things.</p>
<p>All sorts of things.</p>
<p>If you aren&rsquo;t failing on some front, consider adjusting your difficulty settings.</p>
<p>Come find me later - I might need a hand with something.</p>
<hr>
<p>So here&rsquo;s the deal - there are some seriously bizarre signals floating around this area.</p>
<p>Not your typical radio chatter or WiFi noise, but something&hellip; different.</p>
<p>I&rsquo;ve been trying to make sense of the patterns, but it&rsquo;s like trying to build a robot hand out of a coffee maker - you need the right approach.</p>
<p>Think you can help me decode whatever weirdness is being transmitted out there?</p>
<p>You know what happens to electronics in extreme cold? They fail. All my builds, all my robots, all my weird coffee-maker contraptionsâ€”frozen solid. We can&rsquo;t let Frosty turn this place into a permanent deep freeze.</p>
</blockquote>
<h2 id="solution">Solution</h2>
<p>This objective focuses on low-level hardware communication and protocol analysis rather than traditional network traffic. By working through the 1-Wire communication stages and reversing the XOR-based obfuscation, I had to reconstruct how sensor data is exchanged and protected on constrained devices. The challenge highlights how security weaknesses can emerge in embedded systems when lightweight encryption is applied without strong key management, and how understanding protocol mechanics is essential when investigating IoT-style environments.</p>
<p>The endpoints where extracted by viesing for <em>WS</em> in Network tab:</p>
<table>
  <thead>
      <tr>
          <th>Protocol</th>
          <th>Endpoint name</th>
          <th>Endpoint URL</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1-Wire</td>
          <td>dq</td>
          <td>wss://signals.holidayhackchallenge.com/wire/dq</td>
      </tr>
      <tr>
          <td>SPI</td>
          <td>mosi</td>
          <td>wss://signals.holidayhackchallenge.com/wire/mosi</td>
      </tr>
      <tr>
          <td>SPI</td>
          <td>sck</td>
          <td>wss://signals.holidayhackchallenge.com/wire/sck</td>
      </tr>
      <tr>
          <td>I2C</td>
          <td>sda</td>
          <td>wss://signals.holidayhackchallenge.com/wire/sda</td>
      </tr>
      <tr>
          <td>I2C</td>
          <td>scl</td>
          <td>wss://signals.holidayhackchallenge.com/wire/scl</td>
      </tr>
  </tbody>
</table>
<h3 id="1-wire">1-Wire</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SANS Holiday Hack Challenge 2025 â€“ &#34;On the Wire&#34; (1-Wire / dq)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">What this script does
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1) Connects to the dq WebSocket endpoint.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2) Records one complete transmission (from marker &#34;reset&#34; to marker &#34;stop&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">3) Saves the raw capture to dq_capture.json for reproducibility in a write-up.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">4) Decodes 1-Wire data by measuring LOW pulse widths (timing-based decoding).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">5) Prints decoded bytes as HEX + ASCII and extracts the XOR key if present.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Why timing matters
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">------------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1-Wire does NOT send bits as a simple sequence of 0/1 voltage levels.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Instead, each bit is encoded by how long the line stays LOW during a time slot.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Important implementation detail for this challenge feed:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- The &#39;presence&#39; marker is on the FALLING edge of the presence pulse (v=0).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  If you start decoding immediately at that record, you will accidentally treat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  the presence pulse as a data bit and the entire decode will be shifted.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Therefore, we start decoding AFTER the presence pulse ends (next v==1).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Expected outcome
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">----------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">The decoded ASCII should include an instruction ending with:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;... XOR key: icy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> websocket
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> Counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Capture control</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>START_MARKER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;reset&#34;</span>
</span></span><span style="display:flex;"><span>STOP_MARKER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stop&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>recording <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>recording_done <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>recorded <span style="color:#f92672">=</span> []  <span style="color:#75715e"># list of dict frames</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_message</span>(ws, message: str):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Capture frames between START_MARKER and STOP_MARKER.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> recording, recording_done, recorded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> recording_done:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(message)
</span></span><span style="display:flex;"><span>    marker <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;marker&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Start recording at reset</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> recording <span style="color:#f92672">and</span> marker <span style="color:#f92672">==</span> START_MARKER:
</span></span><span style="display:flex;"><span>        recording <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        recorded <span style="color:#f92672">=</span> [msg]  <span style="color:#75715e"># include reset frame</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;START recording (reset)&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Ignore everything until we see the start marker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> recording:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Recording phase</span>
</span></span><span style="display:flex;"><span>    recorded<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Stop recording at stop marker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> marker <span style="color:#f92672">==</span> STOP_MARKER:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;STOP recording (stop). Events captured: </span><span style="color:#e6db74">{</span>len(recorded)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        recording <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        recording_done <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        ws<span style="color:#f92672">.</span>keep_running <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        ws<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_error</span>(ws, error):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;WebSocket error:&#34;</span>, error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_close</span>(ws, close_status_code, close_msg):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Connection Closed&#34;</span>, close_status_code, close_msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1-Wire decoding helpers</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collapse_levels</span>(frames):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Collapse consecutive identical levels to obtain a transition list.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Input : list of frames dicts with keys t, v
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Output: list of (t, v) tuples where v flips each entry
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    frames <span style="color:#f92672">=</span> sorted(frames, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#e6db74">&#34;t&#34;</span>])
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    last_v <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> frames:
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> f[<span style="color:#e6db74">&#34;t&#34;</span>]
</span></span><span style="display:flex;"><span>        v <span style="color:#f92672">=</span> int(f[<span style="color:#e6db74">&#34;v&#34;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> last_v <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> v <span style="color:#f92672">!=</span> last_v:
</span></span><span style="display:flex;"><span>            out<span style="color:#f92672">.</span>append((t, v))
</span></span><span style="display:flex;"><span>            last_v <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_low_pulse_widths</span>(transitions):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Extract LOW pulse widths.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    A LOW pulse is a segment where v==0 followed by v==1.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Width = t_rise - t_fall
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    widths <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(transitions) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        t0, v0 <span style="color:#f92672">=</span> transitions[i]
</span></span><span style="display:flex;"><span>        t1, v1 <span style="color:#f92672">=</span> transitions[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> v0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> v1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            widths<span style="color:#f92672">.</span>append(t1 <span style="color:#f92672">-</span> t0)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> widths
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">infer_threshold</span>(widths):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Infer a threshold separating short and long LOW pulses.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This challenge feed typically has two dominant widths (e.g. 6 and 60).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    We take the two most common widths and set the threshold midway.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    counts <span style="color:#f92672">=</span> Counter(widths)
</span></span><span style="display:flex;"><span>    common <span style="color:#f92672">=</span> [w <span style="color:#66d9ef">for</span> (w, _n) <span style="color:#f92672">in</span> counts<span style="color:#f92672">.</span>most_common(<span style="color:#ae81ff">5</span>)]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(common) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Not enough distinct pulse widths to infer threshold.&#34;</span>)
</span></span><span style="display:flex;"><span>    w_short <span style="color:#f92672">=</span> min(common[<span style="color:#ae81ff">0</span>], common[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    w_long <span style="color:#f92672">=</span> max(common[<span style="color:#ae81ff">0</span>], common[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    threshold <span style="color:#f92672">=</span> (w_short <span style="color:#f92672">+</span> w_long) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> threshold, w_short, w_long, counts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bits_to_bytes_lsb</span>(bits):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    1-Wire transmits bits LSB-first within each byte.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    bit0 is sent first, then bit1, ..., bit7.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    cur <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> bits:
</span></span><span style="display:flex;"><span>        cur <span style="color:#f92672">|=</span> (b <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> pos
</span></span><span style="display:flex;"><span>        pos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>:
</span></span><span style="display:flex;"><span>            out<span style="color:#f92672">.</span>append(cur)
</span></span><span style="display:flex;"><span>            cur <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(out)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hexdump_and_ascii</span>(data: bytes):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Return a (hex_string, ascii_string) pair.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    hx <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>b<span style="color:#e6db74">:</span><span style="color:#e6db74">02x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> data)
</span></span><span style="display:flex;"><span>    asc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(chr(b) <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7E</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hx, asc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_decode_start_index</span>(frames):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Start decoding AFTER the presence pulse ends.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The feed marks:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      presence marker at the FALLING edge (v=0)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    So we must move to the next frame where v==1 after that timestamp,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    otherwise the presence pulse width (e.g. 150) will be misread as a data bit.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    If no presence marker exists, fall back to &#34;reset&#34; and start after it returns high.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    frames <span style="color:#f92672">=</span> sorted(frames, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#e6db74">&#34;t&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_after_marker</span>(marker_name: str):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i, f <span style="color:#f92672">in</span> enumerate(frames):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> f<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;marker&#34;</span>) <span style="color:#f92672">==</span> marker_name:
</span></span><span style="display:flex;"><span>                t_mark <span style="color:#f92672">=</span> f[<span style="color:#e6db74">&#34;t&#34;</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Find next rising level (v==1) AFTER this marker timestamp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, len(frames)):
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> frames[j][<span style="color:#e6db74">&#34;t&#34;</span>] <span style="color:#f92672">&gt;</span> t_mark <span style="color:#f92672">and</span> int(frames[j][<span style="color:#e6db74">&#34;v&#34;</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> j
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> i
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    idx <span style="color:#f92672">=</span> start_after_marker(<span style="color:#e6db74">&#34;presence&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> idx <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> idx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    idx <span style="color:#f92672">=</span> start_after_marker(<span style="color:#e6db74">&#34;reset&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> idx <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> idx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_1wire</span>(frames):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Full pipeline:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - Determine correct start index (after presence pulse ends)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - Collapse levels to transitions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - Extract LOW widths
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - Infer threshold separating short vs long widths
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - Map short-&gt;1, long-&gt;0 (standard 1-wire convention)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - Pack bits LSB-first into bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    start_idx <span style="color:#f92672">=</span> find_decode_start_index(frames)
</span></span><span style="display:flex;"><span>    subset <span style="color:#f92672">=</span> frames[start_idx:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    transitions <span style="color:#f92672">=</span> collapse_levels(subset)
</span></span><span style="display:flex;"><span>    widths <span style="color:#f92672">=</span> extract_low_pulse_widths(transitions)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    threshold, w_short, w_long, counts <span style="color:#f92672">=</span> infer_threshold(widths)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Standard mapping for this challenge stream:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   short low pulse =&gt; bit 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   long  low pulse =&gt; bit 0</span>
</span></span><span style="display:flex;"><span>    bits <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> w <span style="color:#f92672">&lt;</span> threshold <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> widths]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    decoded <span style="color:#f92672">=</span> bits_to_bytes_lsb(bits)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decoded, {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;start_idx&#34;</span>: start_idx,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;counts&#34;</span>: counts,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;threshold&#34;</span>: threshold,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;w_short&#34;</span>: w_short,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;w_long&#34;</span>: w_long,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;num_widths&#34;</span>: len(widths),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;num_bits&#34;</span>: len(bits),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;num_bytes&#34;</span>: len(decoded),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_printable</span>(data: bytes) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Extract printable ASCII characters for quick human inspection.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(chr(b) <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> data <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7E</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Main</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    endpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wss://signals.holidayhackchallenge.com/wire/dq&#34;</span>
</span></span><span style="display:flex;"><span>    ws <span style="color:#f92672">=</span> websocket<span style="color:#f92672">.</span>WebSocketApp(
</span></span><span style="display:flex;"><span>        endpoint,
</span></span><span style="display:flex;"><span>        on_message<span style="color:#f92672">=</span>on_message,
</span></span><span style="display:flex;"><span>        on_error<span style="color:#f92672">=</span>on_error,
</span></span><span style="display:flex;"><span>        on_close<span style="color:#f92672">=</span>on_close,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ws<span style="color:#f92672">.</span>run_forever()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Save raw capture for your write-up</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;dq_capture.json&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> out:
</span></span><span style="display:flex;"><span>        json<span style="color:#f92672">.</span>dump(recorded, out, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    decoded, meta <span style="color:#f92672">=</span> decode_1wire(recorded)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- LOW pulse width histogram (top 10) ---&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> w, n <span style="color:#f92672">in</span> meta[<span style="color:#e6db74">&#34;counts&#34;</span>]<span style="color:#f92672">.</span>most_common(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;width=</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">:</span><span style="color:#e6db74">&gt;6</span><span style="color:#e6db74">}</span><span style="color:#e6db74">  count=</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Decode parameters ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;decode start index: </span><span style="color:#e6db74">{</span>meta[<span style="color:#e6db74">&#39;start_idx&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;short width: </span><span style="color:#e6db74">{</span>meta[<span style="color:#e6db74">&#39;w_short&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;long  width: </span><span style="color:#e6db74">{</span>meta[<span style="color:#e6db74">&#39;w_long&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;threshold : </span><span style="color:#e6db74">{</span>meta[<span style="color:#e6db74">&#39;threshold&#39;</span>]<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> (short&lt;thr =&gt; bit=1)&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;bits      : </span><span style="color:#e6db74">{</span>meta[<span style="color:#e6db74">&#39;num_bits&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;bytes     : </span><span style="color:#e6db74">{</span>meta[<span style="color:#e6db74">&#39;num_bytes&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hx, asc <span style="color:#f92672">=</span> hexdump_and_ascii(decoded)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Decoded payload ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;HEX  :&#34;</span>, hx)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;ASCII:&#34;</span>, asc)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printable <span style="color:#f92672">=</span> extract_printable(decoded)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Printable only ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(printable)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Optional: try to pull a key after &#34;key:&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;key:&#34;</span> <span style="color:#f92672">in</span> printable<span style="color:#f92672">.</span>lower():
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split on last occurrence of &#39;:&#39; to be tolerant of other colons earlier</span>
</span></span><span style="display:flex;"><span>        candidate <span style="color:#f92672">=</span> printable<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Candidate XOR key ---&#34;</span>)
</span></span><span style="display:flex;"><span>        print(candidate)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()</span></span></code></pre></div>
<p>This script outputted:</p>
<p><a href="#R-image-a4b09c3cb3e7248e2e9cc84a2f50ed1e" class="lightbox-link"><img alt="1-Wire XOR" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-onthewire-1.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a4b09c3cb3e7248e2e9cc84a2f50ed1e"><img alt="1-Wire XOR" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-onthewire-1.png"></a></p>
<p>The XOR key is:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>icy</span></span></code></pre></div>
<h3 id="spi">SPI</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SANS Holiday Hack Challenge 2025 â€“ &#34;On the Wire&#34; (SPI stage, LIVE)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">==================================================================
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Goal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">----
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Capture the LIVE SPI signals from the WebSocket &#34;wires&#34; and decode the byte stream.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Then XOR-decrypt it using the key recovered from the 1-Wire stage (key: &#34;icy&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Why brute force is necessary here
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SPI decoding depends on:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Which clock edge you sample on (rising vs falling) -&gt; CPHA/Mode issues
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Bit order within each byte (MSB-first vs LSB-first)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Byte alignment (you might start sampling 1â€“7 bits too early/late)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">If any of these are wrong, XOR output may look like printable garbage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">(&#34;text-like&#34;, but no real words). The fastest way to recover is to brute force:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - edge âˆˆ {rising, falling}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - bit_order âˆˆ {msb, lsb}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - bit_shift âˆˆ {0..7}  (re-align byte boundaries)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">This script:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  1) Connects to /wire/sck and /wire/mosi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  2) Captures one broadcast loop (detected by MOSI timestamp wrap-around t dropping)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  3) Decodes using the brute-force matrix above
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  4) Ranks candidates by a simple plaintext-likeness score
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  5) Prints top candidates and full hexdump for the best candidate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Reproducibility
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- The script saves the raw samples to spi_sck_live.json and spi_mosi_live.json.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> annotations
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List, Optional, Tuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> websocket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span>SCK_ENDPOINT  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wss://signals.holidayhackchallenge.com/wire/sck&#34;</span>
</span></span><span style="display:flex;"><span>MOSI_ENDPOINT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wss://signals.holidayhackchallenge.com/wire/mosi&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># XOR key from 1-Wire stage</span>
</span></span><span style="display:flex;"><span>XOR_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;icy&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Capture stop conditions</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span>MAX_CAPTURE_SECONDS <span style="color:#f92672">=</span> <span style="color:#ae81ff">20.0</span>   <span style="color:#75715e"># safety cap</span>
</span></span><span style="display:flex;"><span>POST_WRAP_GRACE_MS <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>     <span style="color:#75715e"># let a little extra data arrive after wrap detected</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Data structures</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>(frozen<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Event</span>:
</span></span><span style="display:flex;"><span>    t: int
</span></span><span style="display:flex;"><span>    v: int
</span></span><span style="display:flex;"><span>    marker: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lock <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Lock()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wire_frames <span style="color:#f92672">=</span> defaultdict(list)  <span style="color:#75715e"># wire_frames[&#34;sck&#34;] = [Event...], [&#34;mosi&#34;] = [Event...]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>done <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>wrap_detected <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>wrap_wallclock_time: Optional[float] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mosi_last_t: Optional[int] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>mosi_saw_advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>last_any_message_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Waveform helpers</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collapse_levels</span>(events: List[Event]) <span style="color:#f92672">-&gt;</span> List[Tuple[int, int]]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Collapse consecutive identical v values to obtain transitions (t, v).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    events <span style="color:#f92672">=</span> sorted(events, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> e: e<span style="color:#f92672">.</span>t)
</span></span><span style="display:flex;"><span>    out: List[Tuple[int, int]] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    last_v: Optional[int] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> events:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> last_v <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> e<span style="color:#f92672">.</span>v <span style="color:#f92672">!=</span> last_v:
</span></span><span style="display:flex;"><span>            out<span style="color:#f92672">.</span>append((e<span style="color:#f92672">.</span>t, e<span style="color:#f92672">.</span>v))
</span></span><span style="display:flex;"><span>            last_v <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span>v
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_edges</span>(clock_transitions: List[Tuple[int, int]], edge: str) <span style="color:#f92672">-&gt;</span> List[int]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Extract timestamps of clock edges (rising or falling) from collapsed transitions.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    times: List[int] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, len(clock_transitions)):
</span></span><span style="display:flex;"><span>        t_prev, v_prev <span style="color:#f92672">=</span> clock_transitions[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        t_now, v_now   <span style="color:#f92672">=</span> clock_transitions[i]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> edge <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;rising&#34;</span> <span style="color:#f92672">and</span> v_prev <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> v_now <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            times<span style="color:#f92672">.</span>append(t_now)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> edge <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;falling&#34;</span> <span style="color:#f92672">and</span> v_prev <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> v_now <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            times<span style="color:#f92672">.</span>append(t_now)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> times
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sample_level_at</span>(transitions: List[Tuple[int, int]], t_edge: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Return the line level at time t_edge given transitions [(t, v), ...].
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Linear scan is fine for the challenge capture sizes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> transitions:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    cur <span style="color:#f92672">=</span> transitions[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t, v <span style="color:#f92672">in</span> transitions:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> t <span style="color:#f92672">&gt;</span> t_edge:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        cur <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> cur
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bits_to_bytes</span>(bits: List[int], bit_order: str) <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Pack bits into bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - msb: b = (b&lt;&lt;1) | bit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - lsb: b |= bit &lt;&lt; position
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">=</span> bytearray()
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> len(bits) <span style="color:#f92672">-</span> (len(bits) <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> bit_order <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;msb&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, n, <span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>            b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> bits[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]:
</span></span><span style="display:flex;"><span>                b <span style="color:#f92672">=</span> (b <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> (bit <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            out<span style="color:#f92672">.</span>append(b)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> bit_order <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lsb&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, n, <span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>            b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> pos, bit <span style="color:#f92672">in</span> enumerate(bits[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]):
</span></span><span style="display:flex;"><span>                b <span style="color:#f92672">|=</span> (bit <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> pos
</span></span><span style="display:flex;"><span>            out<span style="color:#f92672">.</span>append(b)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;bit_order must be &#39;msb&#39; or &#39;lsb&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(out)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">xor_repeat</span>(data: bytes, key: bytes) <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    XOR with a repeating key (same operation for encrypt/decrypt).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(b <span style="color:#f92672">^</span> key[i <span style="color:#f92672">%</span> len(key)] <span style="color:#66d9ef">for</span> i, b <span style="color:#f92672">in</span> enumerate(data))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hexdump_ascii</span>(data: bytes, width: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Hex + ASCII dump for write-ups.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">p</span>(x: int) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> chr(x) <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7E</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span>    lines <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(data), width):
</span></span><span style="display:flex;"><span>        chunk <span style="color:#f92672">=</span> data[i:i<span style="color:#f92672">+</span>width]
</span></span><span style="display:flex;"><span>        hexpart <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>b<span style="color:#e6db74">:</span><span style="color:#e6db74">02x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> chunk)
</span></span><span style="display:flex;"><span>        asciipart <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(p(b) <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> chunk)
</span></span><span style="display:flex;"><span>        lines<span style="color:#f92672">.</span>append(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">:</span><span style="color:#e6db74">04x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">  </span><span style="color:#e6db74">{</span>hexpart<span style="color:#e6db74">:</span><span style="color:#e6db74">&lt;</span><span style="color:#e6db74">{</span>width<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#e6db74">}}</span><span style="color:#e6db74">  </span><span style="color:#e6db74">{</span>asciipart<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(lines)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Brute-force SPI decode scoring</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shift_bits</span>(bits: List[int], shift: int) <span style="color:#f92672">-&gt;</span> List[int]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Drop the first &#39;shift&#39; bits to realign byte boundaries.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    shift is 0..7.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> shift <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> bits
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> shift <span style="color:#f92672">&gt;=</span> len(bits):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bits[shift:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">score_plaintext</span>(data: bytes) <span style="color:#f92672">-&gt;</span> float:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Heuristic scoring:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - printable ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - presence of common tokens that appear in HHC hint payloads
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> data:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printable <span style="color:#f92672">=</span> sum(
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> data
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7E</span> <span style="color:#f92672">or</span> x <span style="color:#f92672">in</span> (<span style="color:#ae81ff">0x0A</span>, <span style="color:#ae81ff">0x0D</span>, <span style="color:#ae81ff">0x09</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    ratio <span style="color:#f92672">=</span> printable <span style="color:#f92672">/</span> len(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(chr(x) <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7E</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> data)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tokens <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#e6db74">&#34;xor&#34;</span>, <span style="color:#e6db74">&#34;addr&#34;</span>, <span style="color:#e6db74">&#34;address&#34;</span>, <span style="color:#e6db74">&#34;i2c&#34;</span>, <span style="color:#e6db74">&#34;target&#34;</span>, <span style="color:#e6db74">&#34;device&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;use&#34;</span>, <span style="color:#e6db74">&#34;decrypt&#34;</span>, <span style="color:#e6db74">&#34;payload&#34;</span>, <span style="color:#e6db74">&#34;{&#34;</span>, <span style="color:#e6db74">&#34;}&#34;</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#e6db74">&#34;=&#34;</span>, <span style="color:#e6db74">&#34;[&#34;</span>, <span style="color:#e6db74">&#34;]&#34;</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    hits <span style="color:#f92672">=</span> sum(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> tokens <span style="color:#66d9ef">if</span> t <span style="color:#f92672">in</span> s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># printable ratio dominates; token hits add small bonus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ratio <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.15</span> <span style="color:#f92672">*</span> hits)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try_all_spi_decodes</span>(sck_events: List[Event], mosi_events: List[Event], xor_key: bytes):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Try combinations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - edge: rising/falling
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - bit_order: msb/lsb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - bit_shift: 0..7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns list of tuples:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (score, edge, bit_order, shift, raw_bytes, decrypted_bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sorted by descending score.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sck_trans <span style="color:#f92672">=</span> collapse_levels(sck_events)
</span></span><span style="display:flex;"><span>    mosi_trans <span style="color:#f92672">=</span> collapse_levels(mosi_events)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    candidates <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> edge <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#34;rising&#34;</span>, <span style="color:#e6db74">&#34;falling&#34;</span>):
</span></span><span style="display:flex;"><span>        edge_times <span style="color:#f92672">=</span> extract_edges(sck_trans, edge)
</span></span><span style="display:flex;"><span>        bits <span style="color:#f92672">=</span> [sample_level_at(mosi_trans, t) <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> edge_times]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> bit_order <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#34;msb&#34;</span>, <span style="color:#e6db74">&#34;lsb&#34;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> shift <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>                bits2 <span style="color:#f92672">=</span> shift_bits(bits, shift)
</span></span><span style="display:flex;"><span>                raw <span style="color:#f92672">=</span> bits_to_bytes(bits2, bit_order)
</span></span><span style="display:flex;"><span>                dec <span style="color:#f92672">=</span> xor_repeat(raw, xor_key)
</span></span><span style="display:flex;"><span>                sc <span style="color:#f92672">=</span> score_plaintext(dec)
</span></span><span style="display:flex;"><span>                candidates<span style="color:#f92672">.</span>append((sc, edge, bit_order, shift, raw, dec))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    candidates<span style="color:#f92672">.</span>sort(key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">0</span>], reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> candidates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># WebSocket callbacks</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_message_sck</span>(ws, message: str):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> last_any_message_time
</span></span><span style="display:flex;"><span>    obj <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(obj, dict):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;line&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;sck&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;t&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> obj <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;v&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> obj:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    e <span style="color:#f92672">=</span> Event(t<span style="color:#f92672">=</span>int(obj[<span style="color:#e6db74">&#34;t&#34;</span>]), v<span style="color:#f92672">=</span>int(obj[<span style="color:#e6db74">&#34;v&#34;</span>]), marker<span style="color:#f92672">=</span>obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;marker&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>        last_any_message_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        wire_frames[<span style="color:#e6db74">&#34;sck&#34;</span>]<span style="color:#f92672">.</span>append(e)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_message_mosi</span>(ws, message: str):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> done, wrap_detected, wrap_wallclock_time
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> mosi_last_t, mosi_saw_advance, last_any_message_time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    obj <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(obj, dict):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;line&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;mosi&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;t&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> obj <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;v&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> obj:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> int(obj[<span style="color:#e6db74">&#34;t&#34;</span>])
</span></span><span style="display:flex;"><span>    v <span style="color:#f92672">=</span> int(obj[<span style="color:#e6db74">&#34;v&#34;</span>])
</span></span><span style="display:flex;"><span>    e <span style="color:#f92672">=</span> Event(t<span style="color:#f92672">=</span>t, v<span style="color:#f92672">=</span>v, marker<span style="color:#f92672">=</span>obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;marker&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>        last_any_message_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        wire_frames[<span style="color:#e6db74">&#34;mosi&#34;</span>]<span style="color:#f92672">.</span>append(e)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> mosi_last_t <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            mosi_last_t <span style="color:#f92672">=</span> t
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> t <span style="color:#f92672">&gt;</span> mosi_last_t:
</span></span><span style="display:flex;"><span>            mosi_saw_advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># loop boundary: time drops after we have seen time advance</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> mosi_saw_advance <span style="color:#f92672">and</span> t <span style="color:#f92672">&lt;</span> mosi_last_t <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> wrap_detected:
</span></span><span style="display:flex;"><span>            wrap_detected <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            wrap_wallclock_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        mosi_last_t <span style="color:#f92672">=</span> t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_error</span>(ws, error):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;WebSocket error:&#34;</span>, error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_close</span>(ws, close_status_code, close_msg):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Normal when we stop capture</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Supervisor</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">supervisor</span>(ws_sck: websocket<span style="color:#f92672">.</span>WebSocketApp, ws_mosi: websocket<span style="color:#f92672">.</span>WebSocketApp):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> done
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    started <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.05</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>            now <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># hard cap</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> started <span style="color:#f92672">&gt;</span> MAX_CAPTURE_SECONDS:
</span></span><span style="display:flex;"><span>                done <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># if loop wrap detected, wait a brief grace window then stop</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> wrap_detected <span style="color:#f92672">and</span> wrap_wallclock_time <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (now <span style="color:#f92672">-</span> wrap_wallclock_time) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000.0</span> <span style="color:#f92672">&gt;=</span> POST_WRAP_GRACE_MS:
</span></span><span style="display:flex;"><span>                    done <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> done:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        ws_sck<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        ws_mosi<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">slice_one_loop_by_t_reset</span>(events: List[Event]) <span style="color:#f92672">-&gt;</span> List[Event]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Slice exactly one loop based on the first detected wrap (t decreases).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Uses the event ordering by t. Works well for the HHC looped streams.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> events:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> events
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ev <span style="color:#f92672">=</span> sorted(events, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> e: e<span style="color:#f92672">.</span>t)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># find first t==0 (common) or a wrap point; prefer t==0 if present</span>
</span></span><span style="display:flex;"><span>    first0 <span style="color:#f92672">=</span> next((i <span style="color:#66d9ef">for</span> i, e <span style="color:#f92672">in</span> enumerate(ev) <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>t <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> first0 <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># fallback: find first drop</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, len(ev)):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ev[i]<span style="color:#f92672">.</span>t <span style="color:#f92672">&lt;</span> ev[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>t:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> ev[:i]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># find next t==0 after time advanced</span>
</span></span><span style="display:flex;"><span>    advanced <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(first0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, len(ev)):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ev[j]<span style="color:#f92672">.</span>t <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            advanced <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> advanced <span style="color:#f92672">and</span> ev[j]<span style="color:#f92672">.</span>t <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ev[first0:j]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ev[first0:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Main</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> done
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ws_sck <span style="color:#f92672">=</span> websocket<span style="color:#f92672">.</span>WebSocketApp(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;wss://signals.holidayhackchallenge.com/wire/sck&#34;</span>,
</span></span><span style="display:flex;"><span>        on_message<span style="color:#f92672">=</span>on_message_sck,
</span></span><span style="display:flex;"><span>        on_error<span style="color:#f92672">=</span>on_error,
</span></span><span style="display:flex;"><span>        on_close<span style="color:#f92672">=</span>on_close,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    ws_mosi <span style="color:#f92672">=</span> websocket<span style="color:#f92672">.</span>WebSocketApp(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;wss://signals.holidayhackchallenge.com/wire/mosi&#34;</span>,
</span></span><span style="display:flex;"><span>        on_message<span style="color:#f92672">=</span>on_message_mosi,
</span></span><span style="display:flex;"><span>        on_error<span style="color:#f92672">=</span>on_error,
</span></span><span style="display:flex;"><span>        on_close<span style="color:#f92672">=</span>on_close,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t_sck <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>ws_sck<span style="color:#f92672">.</span>run_forever, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    t_mosi <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>ws_mosi<span style="color:#f92672">.</span>run_forever, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    t_sck<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    t_mosi<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sup <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>supervisor, args<span style="color:#f92672">=</span>(ws_sck, ws_mosi), daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    sup<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    sup<span style="color:#f92672">.</span>join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>        sck_all <span style="color:#f92672">=</span> list(wire_frames[<span style="color:#e6db74">&#34;sck&#34;</span>])
</span></span><span style="display:flex;"><span>        mosi_all <span style="color:#f92672">=</span> list(wire_frames[<span style="color:#e6db74">&#34;mosi&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Save raw capture for write-up reproducibility</span>
</span></span><span style="display:flex;"><span>    Path(<span style="color:#e6db74">&#34;spi_sck_live.json&#34;</span>)<span style="color:#f92672">.</span>write_text(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(json<span style="color:#f92672">.</span>dumps({<span style="color:#e6db74">&#34;t&#34;</span>: e<span style="color:#f92672">.</span>t, <span style="color:#e6db74">&#34;v&#34;</span>: e<span style="color:#f92672">.</span>v, <span style="color:#e6db74">&#34;marker&#34;</span>: e<span style="color:#f92672">.</span>marker}) <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> sck_all),
</span></span><span style="display:flex;"><span>        encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    Path(<span style="color:#e6db74">&#34;spi_mosi_live.json&#34;</span>)<span style="color:#f92672">.</span>write_text(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(json<span style="color:#f92672">.</span>dumps({<span style="color:#e6db74">&#34;t&#34;</span>: e<span style="color:#f92672">.</span>t, <span style="color:#e6db74">&#34;v&#34;</span>: e<span style="color:#f92672">.</span>v, <span style="color:#e6db74">&#34;marker&#34;</span>: e<span style="color:#f92672">.</span>marker}) <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> mosi_all),
</span></span><span style="display:flex;"><span>        encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> sck_all <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> mosi_all:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>(<span style="color:#e6db74">&#34;Capture failed: missing SCK or MOSI data.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Slice to one loop using MOSI&#39;s t-reset behavior</span>
</span></span><span style="display:flex;"><span>    mosi_loop <span style="color:#f92672">=</span> slice_one_loop_by_t_reset(mosi_all)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Align SCK window roughly to MOSI loop time range</span>
</span></span><span style="display:flex;"><span>    t_min <span style="color:#f92672">=</span> min(e<span style="color:#f92672">.</span>t <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> mosi_loop)
</span></span><span style="display:flex;"><span>    t_max <span style="color:#f92672">=</span> max(e<span style="color:#f92672">.</span>t <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> mosi_loop)
</span></span><span style="display:flex;"><span>    sck_loop <span style="color:#f92672">=</span> [e <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> sck_all <span style="color:#66d9ef">if</span> t_min <span style="color:#f92672">&lt;=</span> e<span style="color:#f92672">.</span>t <span style="color:#f92672">&lt;=</span> t_max]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Capture summary ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;MOSI events (all) : </span><span style="color:#e6db74">{</span>len(mosi_all)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;SCK  events (all) : </span><span style="color:#e6db74">{</span>len(sck_all)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;MOSI events (loop): </span><span style="color:#e6db74">{</span>len(mosi_loop)<span style="color:#e6db74">}</span><span style="color:#e6db74">  t=[</span><span style="color:#e6db74">{</span>t_min<span style="color:#e6db74">}</span><span style="color:#e6db74">..</span><span style="color:#e6db74">{</span>t_max<span style="color:#e6db74">}</span><span style="color:#e6db74">]&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;SCK  events (win) : </span><span style="color:#e6db74">{</span>len(sck_loop)<span style="color:#e6db74">}</span><span style="color:#e6db74">  t=[</span><span style="color:#e6db74">{</span>t_min<span style="color:#e6db74">}</span><span style="color:#e6db74">..</span><span style="color:#e6db74">{</span>t_max<span style="color:#e6db74">}</span><span style="color:#e6db74">]&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Brute-force decode matrix</span>
</span></span><span style="display:flex;"><span>    cands <span style="color:#f92672">=</span> try_all_spi_decodes(sck_loop, mosi_loop, xor_key<span style="color:#f92672">=</span>XOR_KEY)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Top SPI decode candidates ---&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> sc, edge, order, shift, _raw, dec <span style="color:#f92672">in</span> cands[:<span style="color:#ae81ff">8</span>]:
</span></span><span style="display:flex;"><span>        printable <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(chr(b) <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> dec <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7E</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">score=</span><span style="color:#e6db74">{</span>sc<span style="color:#e6db74">:</span><span style="color:#e6db74">.3f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> edge=</span><span style="color:#e6db74">{</span>edge<span style="color:#e6db74">:</span><span style="color:#e6db74">7</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> order=</span><span style="color:#e6db74">{</span>order<span style="color:#e6db74">:</span><span style="color:#e6db74">3</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> shift=</span><span style="color:#e6db74">{</span>shift<span style="color:#e6db74">}</span><span style="color:#e6db74">  bytes=</span><span style="color:#e6db74">{</span>len(dec)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        print(printable[:<span style="color:#ae81ff">240</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Print full dump for the best candidate</span>
</span></span><span style="display:flex;"><span>    best <span style="color:#f92672">=</span> cands[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    sc, edge, order, shift, raw, dec <span style="color:#f92672">=</span> best
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">=== BEST CANDIDATE (full dump) ===&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;score=</span><span style="color:#e6db74">{</span>sc<span style="color:#e6db74">:</span><span style="color:#e6db74">.3f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> edge=</span><span style="color:#e6db74">{</span>edge<span style="color:#e6db74">}</span><span style="color:#e6db74"> bit_order=</span><span style="color:#e6db74">{</span>order<span style="color:#e6db74">}</span><span style="color:#e6db74"> bit_shift=</span><span style="color:#e6db74">{</span>shift<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- RAW ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(hexdump_ascii(raw))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- DECRYPTED (XOR key=&#39;icy&#39;) ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(hexdump_ascii(dec))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printable_full <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(chr(b) <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> dec <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x7E</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Decrypted printable-only (full) ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(printable_full)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()</span></span></code></pre></div>
<p>This script outputted:</p>
<p><a href="#R-image-c66a61dd37235c725ae3dc206d46b970" class="lightbox-link"><img alt="SPI output" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-onthewire-2.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c66a61dd37235c725ae3dc206d46b970"><img alt="SPI output" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-onthewire-2.png"></a></p>
<p>Decryptred text is:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>read and decrypt the I2C bus data using the XOR key: bananza. the temperature sensor address is 0x3</span></span></code></pre></div>
<h3 id="i2c">I2C</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SANS HHC 2025 â€“ On the Wire â€“ I2C (LIVE, final)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Known facts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Target IÂ²C device (7-bit) = 0x3C
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- XOR key = &#34;bananza&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Expected answer format = xx.xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Observed bus behavior in your run:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- No READ transactions in this segment (R=0, W=2), so decode WRITE payloads.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Correct framing is &#34;Mode A&#34; (no ACK bits present in collected address-bit/data-bit stream).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Decrypted payload for 0x3C contains ASCII temperature (e.g., &#34;32.84&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">What this script does:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1) Capture one broadcast loop (timestamp wrap) from SDA/SCL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2) Parse IÂ²C transactions using start/stop markers
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">3) For last transaction to 0x3C:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   - Convert bits-&gt;bytes using Mode A (pack every 8 bits)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   - XOR-decrypt with &#34;bananza&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   - If decrypted text matches r&#34;^</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">d</span><span style="color:#e6db74">{2}</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">d</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">$&#34;, print SUBMIT: xx.xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   - Otherwise print diagnostics and (optional) fallback interpretations
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List, Optional
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> websocket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SDA_ENDPOINT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wss://signals.holidayhackchallenge.com/wire/sda&#34;</span>
</span></span><span style="display:flex;"><span>SCL_ENDPOINT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wss://signals.holidayhackchallenge.com/wire/scl&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TARGET_ADDRESS <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3C</span>
</span></span><span style="display:flex;"><span>XOR_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;bananza&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MAX_CAPTURE_SECONDS <span style="color:#f92672">=</span> <span style="color:#ae81ff">25.0</span>
</span></span><span style="display:flex;"><span>POST_WRAP_GRACE_MS <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RE_ANSWER <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;^\d</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">\.\d</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">$&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BitEvent</span>:
</span></span><span style="display:flex;"><span>    t: int
</span></span><span style="display:flex;"><span>    v: int
</span></span><span style="display:flex;"><span>    marker: Optional[str]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TxBits</span>:
</span></span><span style="display:flex;"><span>    address: int
</span></span><span style="display:flex;"><span>    rw: int
</span></span><span style="display:flex;"><span>    bits_after_addr: List[int]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lock <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Lock()
</span></span><span style="display:flex;"><span>events: List[BitEvent] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wrap_detected <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>wrap_wallclock_time: Optional[float] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>last_t: Optional[int] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>saw_advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">xor_decrypt</span>(data: bytes, key: bytes) <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(b <span style="color:#f92672">^</span> key[i <span style="color:#f92672">%</span> len(key)] <span style="color:#66d9ef">for</span> i, b <span style="color:#f92672">in</span> enumerate(data))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assemble_byte_msb</span>(bits8: List[int]) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> bits8:
</span></span><span style="display:flex;"><span>        b <span style="color:#f92672">=</span> (b <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> (bit <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bits_to_bytes_mode_a</span>(bits: List[int]) <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Mode A: ACK bits are NOT present in the collected bitstream.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Pack sequential 8-bit groups.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">=</span> bytearray()
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> len(bits) <span style="color:#f92672">-</span> (len(bits) <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, n, <span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>        out<span style="color:#f92672">.</span>append(assemble_byte_msb(bits[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(out)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_i2c_transactions</span>(events_in: List[BitEvent]) <span style="color:#f92672">-&gt;</span> List[TxBits]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    START ... STOP framing.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Collect only address-bit and data-bit values (0/1).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The first 8 bits after START are the address byte (MSB-first).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    txs: List[TxBits] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    in_tx <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    bits: List[int] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> events_in:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>marker <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;start&#34;</span>:
</span></span><span style="display:flex;"><span>            in_tx <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>marker <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;stop&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> in_tx <span style="color:#f92672">and</span> len(bits) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">8</span>:
</span></span><span style="display:flex;"><span>                addr_byte <span style="color:#f92672">=</span> assemble_byte_msb(bits[:<span style="color:#ae81ff">8</span>])
</span></span><span style="display:flex;"><span>                address <span style="color:#f92672">=</span> addr_byte <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                rw <span style="color:#f92672">=</span> addr_byte <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                txs<span style="color:#f92672">.</span>append(TxBits(address<span style="color:#f92672">=</span>address, rw<span style="color:#f92672">=</span>rw, bits_after_addr<span style="color:#f92672">=</span>bits[<span style="color:#ae81ff">8</span>:]))
</span></span><span style="display:flex;"><span>            in_tx <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> in_tx <span style="color:#f92672">and</span> e<span style="color:#f92672">.</span>marker <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#34;address-bit&#34;</span>, <span style="color:#e6db74">&#34;data-bit&#34;</span>):
</span></span><span style="display:flex;"><span>            bits<span style="color:#f92672">.</span>append(e<span style="color:#f92672">.</span>v)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> txs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_message_sda</span>(ws, message: str):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> wrap_detected, wrap_wallclock_time, last_t, saw_advance
</span></span><span style="display:flex;"><span>    obj <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(obj, dict) <span style="color:#f92672">or</span> obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;line&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;sda&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> int(obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;t&#34;</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    v <span style="color:#f92672">=</span> int(obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;v&#34;</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    marker <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;marker&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>        events<span style="color:#f92672">.</span>append(BitEvent(t<span style="color:#f92672">=</span>t, v<span style="color:#f92672">=</span>v, marker<span style="color:#f92672">=</span>marker))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> last_t <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> t <span style="color:#f92672">&gt;</span> last_t:
</span></span><span style="display:flex;"><span>                saw_advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> saw_advance <span style="color:#f92672">and</span> t <span style="color:#f92672">&lt;</span> last_t <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> wrap_detected:
</span></span><span style="display:flex;"><span>                wrap_detected <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                wrap_wallclock_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        last_t <span style="color:#f92672">=</span> t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_message_scl</span>(ws, message: str):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Not used; kept to mirror physical bus capture.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">supervisor</span>(ws_sda, ws_scl):
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.05</span>)
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> start <span style="color:#f92672">&gt;</span> MAX_CAPTURE_SECONDS:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> wrap_detected <span style="color:#f92672">and</span> wrap_wallclock_time <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (now <span style="color:#f92672">-</span> wrap_wallclock_time) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span> <span style="color:#f92672">&gt;=</span> POST_WRAP_GRACE_MS:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ws_sda<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    ws_scl<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    ws_sda <span style="color:#f92672">=</span> websocket<span style="color:#f92672">.</span>WebSocketApp(SDA_ENDPOINT, on_message<span style="color:#f92672">=</span>on_message_sda)
</span></span><span style="display:flex;"><span>    ws_scl <span style="color:#f92672">=</span> websocket<span style="color:#f92672">.</span>WebSocketApp(SCL_ENDPOINT, on_message<span style="color:#f92672">=</span>on_message_scl)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1 <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>ws_sda<span style="color:#f92672">.</span>run_forever, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    t2 <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>ws_scl<span style="color:#f92672">.</span>run_forever, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    t1<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    t2<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    supervisor(ws_sda, ws_scl)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>        captured <span style="color:#f92672">=</span> list(events)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    txs <span style="color:#f92672">=</span> parse_i2c_transactions(captured)
</span></span><span style="display:flex;"><span>    target <span style="color:#f92672">=</span> [tx <span style="color:#66d9ef">for</span> tx <span style="color:#f92672">in</span> txs <span style="color:#66d9ef">if</span> tx<span style="color:#f92672">.</span>address <span style="color:#f92672">==</span> TARGET_ADDRESS]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> target:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;No transactions seen for 0x</span><span style="color:#e6db74">{</span>TARGET_ADDRESS<span style="color:#e6db74">:</span><span style="color:#e6db74">02x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    chosen <span style="color:#f92672">=</span> target[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]  <span style="color:#75715e"># value write is typically last</span>
</span></span><span style="display:flex;"><span>    enc <span style="color:#f92672">=</span> bits_to_bytes_mode_a(chosen<span style="color:#f92672">.</span>bits_after_addr)
</span></span><span style="display:flex;"><span>    dec <span style="color:#f92672">=</span> xor_decrypt(enc, XOR_KEY)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try ASCII first (this challenge returns ASCII temperature)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        text <span style="color:#f92672">=</span> dec<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;ascii&#34;</span>, errors<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;strict&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">UnicodeDecodeError</span>:
</span></span><span style="display:flex;"><span>        text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    text <span style="color:#f92672">=</span> text<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Target 0x</span><span style="color:#e6db74">{</span>TARGET_ADDRESS<span style="color:#e6db74">:</span><span style="color:#e6db74">02x</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> transactions: </span><span style="color:#e6db74">{</span>len(target)<span style="color:#e6db74">}</span><span style="color:#e6db74"> (using last)&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Chosen TX rw=</span><span style="color:#e6db74">{</span>chosen<span style="color:#f92672">.</span>rw<span style="color:#e6db74">}</span><span style="color:#e6db74"> bits_after_addr=</span><span style="color:#e6db74">{</span>len(chosen<span style="color:#f92672">.</span>bits_after_addr)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Decrypted ASCII: </span><span style="color:#e6db74">{</span>repr(text)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Decrypted HEX  : </span><span style="color:#e6db74">{</span>dec<span style="color:#f92672">.</span>hex()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> RE_ANSWER<span style="color:#f92672">.</span>fullmatch(text):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">SUBMIT: </span><span style="color:#e6db74">{</span>text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># If not a direct xx.xx string, provide guidance for manual inspection.</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Decrypted output did not match xx.xx. Inspect the ASCII/HEX above.&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;If the value is embedded, search the ASCII for a pattern like </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">d</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">d.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()</span></span></code></pre></div>
<p>This script outputted:</p>
<p><a href="#R-image-636d402a43afa3d95d91ecdf0ec332a6" class="lightbox-link"><img alt="I2C output" class="lazy lightbox figure-image" loading="lazy" src="/images/act3/act3-onthewire-3.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-636d402a43afa3d95d91ecdf0ec332a6"><img alt="I2C output" class="lazy lightbox lightbox-image" loading="lazy" src="/images/act3/act3-onthewire-3.png"></a></p>
<p>The value I was looking for is:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>32.84</span></span></code></pre></div>
<p>Embedded protocols often trade simplicity for security, making protocol literacy a critical defensive skill.</p>
<h2 id="evan-booth-closing-words">Evan Booth closing words</h2>
<p>After solving, Evan says:</p>
<blockquote>
<p>Nice work! You cracked that signal encoding like a pro.</p>
<p>Turns out the weirdness had a method to it after all - just like most of my builds!</p>
</blockquote>
<h2 id="hints">Hints</h2>
<h3 id="on-rails">On Rails</h3>
<ol>
<li>Connect to the captured wire files or endpoints for the relevant wires.</li>
<li>Collect all frames for the transmission (buffer until inactivity or loop boundary).</li>
<li>Identify protocol from wire names (e.g., dq â†’ 1-Wire; mosi/sck â†’ SPI; sda/scl â†’ IÂ²C).</li>
<li>Decode the raw signal:</li>
</ol>
<ul>
<li>Pulse-width protocols: locate fallingâ†’rising transitions and measure low-pulse width.</li>
<li>Clocked protocols: detect clock edges and sample the data line at the specified sampling phase.</li>
</ul>
<ol start="5">
<li>
<p>Assemble bits into bytes taking the correct bit order (LSB vs MSB).</p>
</li>
<li>
<p>Convert bytes to text (printable ASCII or hex as appropriate).</p>
</li>
<li>
<p>Extract information from the decoded output â€” it contains the XOR key or other hints for the next stage.</p>
</li>
<li>
<p>Repeat Stage 1 decoding to recover raw bytes (they will appear random).</p>
</li>
<li>
<p>Apply XOR decryption using the key obtained from the previous stage.</p>
</li>
<li>
<p>Inspect decrypted output for next-stage keys or target device information.</p>
</li>
</ol>
<ul>
<li>Multiple 7-bit device addresses share the same SDA/SCL lines.</li>
<li>START condition: SDA falls while SCL is high. STOP: SDA rises while SCL is high.</li>
<li>First byte of a transaction = (7-bit address &laquo; 1) | R/W. Extract address with address = first_byte &raquo; 1.</li>
<li>Identify and decode every deviceâ€™s transactions; decrypt only the target deviceâ€™s payload.</li>
<li>Print bytes in hex and as ASCII (if printable) â€” hex patterns reveal structure.</li>
<li>Check printable ASCII range (0x20â€“0x7E) to spot valid text.</li>
<li>Verify endianness: swapping LSB/MSB will quickly break readable text.</li>
<li>For XOR keys, test short candidate keys and look for common English words.</li>
<li>If you connect mid-broadcast, wait for the next loop or detect a reset/loop marker before decoding.</li>
<li>Buffering heuristic: treat the stream complete after a short inactivity window (e.g., 500 ms) or after a full broadcast loop.</li>
<li>Sort frames by timestamp per wire and collapse consecutive identical levels before decoding to align with the physical waveform.</li>
</ul>
<h3 id="protocols">Protocols</h3>
<p><strong>Key concept - Clock vs. Data signals:</strong></p>
<ul>
<li>Some protocols have separate clock and data lines (like SPI and I2C)</li>
<li>For clocked protocols, you need to sample the data line at specific moments defined by the clock</li>
<li>The clock signal tells you when to read the data signal</li>
</ul>
<p><strong>For 1-Wire (no separate clock):</strong></p>
<ul>
<li>Information is encoded in pulse widths (how long the signal stays low or high)</li>
<li>Different pulse widths represent different bit values</li>
<li>Look for patterns in the timing between transitions</li>
</ul>
<p><strong>For SPI and I2C:</strong></p>
<ul>
<li>Identify which line is the clock (SCL for I2C, SCK for SPI)</li>
<li>Data is typically valid/stable when the clock is in a specific state (high or low)</li>
<li>You need to detect clock edges (transitions) and sample data at those moments</li>
</ul>
<p><strong>Technical approach:</strong></p>
<ul>
<li>Sort frames by timestamp</li>
<li>Detect rising edges (0â†’1) and falling edges (1â†’0) on the clock line</li>
<li>Sample the data line&rsquo;s value at each clock edge</li>
</ul>
<h3 id="bits-and-bytes">Bits and Bytes</h3>
<p><em>Critical detail - Bit ordering varies by protocol:</em></p>
<p><strong>MSB-first (Most Significant Bit first):</strong></p>
<ul>
<li>SPI and I2C typically send the highest bit (bit 7) first</li>
<li>When assembling bytes: byte = (byte &laquo; 1) | bit_value</li>
<li>Start with an empty byte, shift left, add the new bit</li>
</ul>
<p><strong>LSB-first (Least Significant Bit first):</strong></p>
<ul>
<li>1-Wire and UART send the lowest bit (bit 0) first</li>
<li>When assembling bytes: byte |= bit_value &laquo; bit_position</li>
<li>Build the byte from bit 0 to bit 7</li>
</ul>
<p><strong>I2C specific considerations</strong></p>
<ul>
<li>Every 9th bit is an ACK (acknowledgment) bit - ignore these when decoding data</li>
<li>The first byte in each transaction is the device address (7 bits) plus a R/W bit</li>
<li>You may need to filter for specific device addresses</li>
</ul>
<p><strong>Converting bytes to text:</strong></p>
<p>String.fromCharCode(byte_value)  // Converts byte to ASCII character</p>
<h3 id="garbage">Garbage?</h3>
<p>If your decoded data looks like gibberish:</p>
<ul>
<li>The data may be encrypted with XOR cipher</li>
<li>XOR is a simple encryption: encrypted_byte XOR key_byte = plaintext_byte</li>
<li>The same operation both encrypts and decrypts: plaintext XOR key = encrypted, encrypted XOR key = plaintext</li>
</ul>
<p><strong>How XOR cipher works:</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>function xorDecrypt(encrypted, key) {
</span></span><span style="display:flex;"><span>  let result = &#34;&#34;;
</span></span><span style="display:flex;"><span>  for (let i = 0; i &lt; encrypted.length; i++) {
</span></span><span style="display:flex;"><span>    const encryptedChar = encrypted.charCodeAt(i);
</span></span><span style="display:flex;"><span>    const keyChar = key.charCodeAt(i % key.length);  // Key repeats
</span></span><span style="display:flex;"><span>    result += String.fromCharCode(encryptedChar ^ keyChar);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  return result;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p><strong>Key characteristics:</strong></p>
<ul>
<li>The key is typically short and repeats for the length of the message</li>
<li>You need the correct key to decrypt (look for keys in previous stage messages)</li>
<li>If you see readable words mixed with garbage, you might have the wrong key or bit order</li>
</ul>
<p><strong>Testing your decryption:</strong></p>
<ul>
<li>Encrypted data will have random-looking byte values</li>
<li>Decrypted data should be readable ASCII text</li>
<li>Try different keys from messages you&rsquo;ve already decoded</li>
</ul>
<h3 id="structure">Structure</h3>
<p>What you&rsquo;re dealing with:</p>
<ul>
<li>You have access to WebSocket endpoints that stream digital signal data</li>
<li>Each endpoint represents a physical wire in a hardware communication system</li>
<li>The data comes as JSON frames with three properties: line (wire name), t (timestamp), and v (value: 0 or 1)</li>
<li>The server continuously broadcasts signal data in a loop - you can connect at any time</li>
<li>This is a multi-stage challenge where solving one stage reveals information needed for the next</li>
</ul>
<p><strong>Where to start:</strong></p>
<ul>
<li>Connect to a WebSocket endpoint and observe the data format</li>
<li>The server automatically sends data every few seconds - just wait and collect</li>
<li>Look for documentation on the protocol types mentioned (1-Wire, SPI, I2C)</li>
<li>Consider that hardware protocols encode information in the timing and sequence of signal transitions, not just the values themselves</li>
<li>Consider capturing the WebSocket frames to a file so you can work offline</li>
</ul>

  <footer class="footline">
              <i class='fa-fw fas fa-calendar'></i> Dec 23, 2025
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
          <a id="R-logo" class="R-default" href="/index.html">
            <div class="logo-title">SANS Holiday Hack Challenge 2025</div>
          </a>
        </div>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-url="/index.html"><a class="padding" href="/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="parent hidden " data-nav-url="/act3/index.html"><a class="padding" href="/act3/index.html">Act 3</a><ul id="R-subsections-0b6215c9fad834351813cc2ad0d4a335" class="collapsible-menu">
            <li class="" data-nav-url="/act3/gnome-tea/index.html"><a class="padding" href="/act3/gnome-tea/index.html">Gnome Tea</a></li>
            <li class="" data-nav-url="/act3/hack-a-gnome/index.html"><a class="padding" href="/act3/hack-a-gnome/index.html">Hack-a-Gnome</a></li>
            <li class="" data-nav-url="/act3/snowcat-rce-and-priv-esc/index.html"><a class="padding" href="/act3/snowcat-rce-and-priv-esc/index.html">Snowcat RCE &amp; Priv Esc</a></li>
            <li class="" data-nav-url="/act3/schrodingers-scope/index.html"><a class="padding" href="/act3/schrodingers-scope/index.html">SchrÃ¶dingers Scope</a></li>
            <li class="" data-nav-url="/act3/find-and-shutdown-frostys-snowglobe-machine/index.html"><a class="padding" href="/act3/find-and-shutdown-frostys-snowglobe-machine/index.html">Find and Shutdown Frostys Snowglobe Machine</a></li>
            <li class="active " data-nav-url="/act3/on-the-wire/index.html"><a class="padding" href="/act3/on-the-wire/index.html">On the Wire</a></li>
            <li class="" data-nav-url="/act3/free-ski/index.html"><a class="padding" href="/act3/free-ski/index.html">Free Ski</a></li>
            <li class="" data-nav-url="/act3/snowblind-ambush/index.html"><a class="padding" href="/act3/snowblind-ambush/index.html">Snowblind Ambush</a></li></ul></li>
            <li class="" data-nav-url="/about/index.html"><a class="padding" href="/about/index.html">About Roger Johnsen</a></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/clipboard/clipboard.min.js?1767539554" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1767539554" defer></script>
    <script src="/js/theme.js?1767539554" defer></script>
  </body>
</html>
